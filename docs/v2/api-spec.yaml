openapi: 3.0.3
info:
  title: Timesheet API
  version: 0.2.0
  description: |
    API for the Timesheet application v2.

    This is the source of truth for the API contract. All clients (Web, MCP, CLI)
    consume this spec. The Go service is generated from this spec using oapi-codegen.

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.timesheet.example.com
    description: Production

tags:
  - name: auth
    description: Authentication and session management
  - name: projects
    description: Project management
  - name: time-entries
    description: Time entry tracking
  - name: calendars
    description: Calendar integration and event management

paths:
  # Auth endpoints
  /api/auth/signup:
    post:
      operationId: signup
      tags: [auth]
      summary: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      operationId: login
      tags: [auth]
      summary: Authenticate with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/logout:
    post:
      operationId: logout
      tags: [auth]
      summary: End the current session
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Session ended successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/me:
    get:
      operationId: getCurrentUser
      tags: [auth]
      summary: Get current authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Project endpoints
  /api/projects:
    get:
      operationId: listProjects
      tags: [projects]
      summary: List all projects
      description: Returns all projects for the authenticated user
      security:
        - bearerAuth: []
      parameters:
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived projects
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createProject
      tags: [projects]
      summary: Create a new project
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/projects/{id}:
    get:
      operationId: getProject
      tags: [projects]
      summary: Get a project by ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateProject
      tags: [projects]
      summary: Update a project
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectUpdate'
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteProject
      tags: [projects]
      summary: Delete a project
      description: Permanently deletes a project. Use archive for soft delete.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Project deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete (has time entries or invoices)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Time Entry endpoints
  /api/time-entries:
    get:
      operationId: listTimeEntries
      tags: [time-entries]
      summary: List time entries
      description: Returns time entries for the authenticated user, optionally filtered
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: Filter entries on or after this date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: Filter entries on or before this date
        - name: project_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by project
      responses:
        '200':
          description: List of time entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimeEntry'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createTimeEntry
      tags: [time-entries]
      summary: Create a new time entry
      description: Creates a manual time entry. If an entry exists for the same project/date, hours are added.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeEntryCreate'
      responses:
        '201':
          description: Time entry created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/time-entries/{id}:
    get:
      operationId: getTimeEntry
      tags: [time-entries]
      summary: Get a time entry by ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Time entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateTimeEntry
      tags: [time-entries]
      summary: Update a time entry
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeEntryUpdate'
      responses:
        '200':
          description: Time entry updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot edit (entry is invoiced)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteTimeEntry
      tags: [time-entries]
      summary: Delete a time entry
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Time entry deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete (entry is invoiced)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Calendar endpoints
  /api/auth/google/authorize:
    get:
      operationId: googleAuthorize
      tags: [calendars]
      summary: Get Google OAuth authorization URL
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OAuth URL to redirect user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthAuthorizeResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/google/callback:
    get:
      operationId: googleCallback
      tags: [calendars]
      summary: Handle Google OAuth callback
      security:
        - bearerAuth: []
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Google
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        '201':
          description: Calendar connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarConnection'
        '400':
          description: Invalid request (missing code/state)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars:
    get:
      operationId: listCalendarConnections
      tags: [calendars]
      summary: List user's calendar connections
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of calendar connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarConnection'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}:
    delete:
      operationId: deleteCalendarConnection
      tags: [calendars]
      summary: Disconnect a calendar
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Calendar disconnected
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}/sync:
    post:
      operationId: syncCalendar
      tags: [calendars]
      summary: Trigger sync for a calendar connection
      description: Syncs events from all selected calendars within this connection
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResult'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}/sources:
    get:
      operationId: listCalendarSources
      tags: [calendars]
      summary: List available calendars for a connection
      description: Returns all calendars the user has access to in this connected account
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of available calendars
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Calendar'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateCalendarSources
      tags: [calendars]
      summary: Update which calendars are selected for sync
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCalendarSourcesRequest'
      responses:
        '200':
          description: Calendar selection updated
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Calendar'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events:
    get:
      operationId: listCalendarEvents
      tags: [calendars]
      summary: List calendar events with filters
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
        - name: classification_status
          in: query
          schema:
            type: string
            enum: [pending, classified, skipped]
        - name: connection_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of calendar events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarEvent'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events/{id}/classify:
    put:
      operationId: classifyCalendarEvent
      tags: [calendars]
      summary: Classify a calendar event (assign to project or skip)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassifyEventRequest'
      responses:
        '200':
          description: Event classified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassifyEventResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login or signup

  schemas:
    # Auth schemas
    SignupRequest:
      type: object
      required: [email, password, name]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        name:
          type: string
          minLength: 1

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      required: [token, user]
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      required: [id, email, name, created_at]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        created_at:
          type: string
          format: date-time

    # Project schemas
    Project:
      type: object
      required: [id, user_id, name, color, is_billable, is_archived, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
          example: "Acme Corp Website"
        short_code:
          type: string
          maxLength: 10
          example: "ACM"
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          example: "#3B82F6"
        is_billable:
          type: boolean
          default: true
        is_archived:
          type: boolean
          default: false
        is_hidden_by_default:
          type: boolean
          default: false
        does_not_accumulate_hours:
          type: boolean
          default: false
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
        short_code:
          type: string
          maxLength: 10
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          default: "#6B7280"
        is_billable:
          type: boolean
          default: true
        is_hidden_by_default:
          type: boolean
          default: false
        does_not_accumulate_hours:
          type: boolean
          default: false

    ProjectUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        short_code:
          type: string
          maxLength: 10
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        is_billable:
          type: boolean
        is_archived:
          type: boolean
        is_hidden_by_default:
          type: boolean
        does_not_accumulate_hours:
          type: boolean

    # Time Entry schemas
    TimeEntry:
      type: object
      required: [id, user_id, project_id, date, hours, source, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        project:
          $ref: '#/components/schemas/Project'
          description: Included when fetching entries
        date:
          type: string
          format: date
          description: The calendar day for this entry
        hours:
          type: number
          format: float
          minimum: 0
          example: 2.5
        description:
          type: string
          example: "Worked on API design"
        source:
          type: string
          enum: [manual, calendar, import]
          description: How this entry was created
        invoice_id:
          type: string
          format: uuid
          nullable: true
          description: If invoiced, the invoice ID
        has_user_edits:
          type: boolean
          default: false
          description: Whether user has modified this entry
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TimeEntryCreate:
      type: object
      required: [project_id, date, hours]
      properties:
        project_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        hours:
          type: number
          format: float
          minimum: 0
        description:
          type: string

    TimeEntryUpdate:
      type: object
      properties:
        hours:
          type: number
          format: float
          minimum: 0
        description:
          type: string

    # Common schemas
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    # Calendar schemas
    OAuthAuthorizeResponse:
      type: object
      required: [url, state]
      properties:
        url:
          type: string
          format: uri
          description: URL to redirect user for OAuth consent
        state:
          type: string
          description: State token for CSRF protection

    CalendarConnection:
      type: object
      required: [id, user_id, provider, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [google]
        last_synced_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CalendarEvent:
      type: object
      required: [id, connection_id, user_id, external_id, title, start_time, end_time, classification_status, created_at]
      properties:
        id:
          type: string
          format: uuid
        connection_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        external_id:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        attendees:
          type: array
          items:
            type: string
        is_recurring:
          type: boolean
        response_status:
          type: string
          nullable: true
        transparency:
          type: string
          nullable: true
        is_orphaned:
          type: boolean
        is_suppressed:
          type: boolean
        classification_status:
          type: string
          enum: [pending, classified, skipped]
        classification_source:
          type: string
          enum: [rule, fingerprint, manual, llm]
          nullable: true
        project_id:
          type: string
          format: uuid
          nullable: true
        project:
          $ref: '#/components/schemas/Project'
        calendar_name:
          type: string
          nullable: true
          description: Name of the source calendar
        calendar_color:
          type: string
          nullable: true
          description: Color of the source calendar (hex code)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SyncResult:
      type: object
      required: [events_created, events_updated, events_orphaned]
      properties:
        events_created:
          type: integer
        events_updated:
          type: integer
        events_orphaned:
          type: integer

    ClassifyEventRequest:
      type: object
      properties:
        project_id:
          type: string
          format: uuid
          description: Project to assign this event to. Omit or null to skip the event.
        skip:
          type: boolean
          description: Set to true to mark as "did not attend" (skipped)

    ClassifyEventResponse:
      type: object
      required: [event]
      properties:
        event:
          $ref: '#/components/schemas/CalendarEvent'
        time_entry:
          $ref: '#/components/schemas/TimeEntry'
          description: The created or updated time entry (only when classifying to a project)

    Calendar:
      type: object
      required: [id, connection_id, external_id, name, is_primary, is_selected, created_at]
      properties:
        id:
          type: string
          format: uuid
        connection_id:
          type: string
          format: uuid
        external_id:
          type: string
          description: Google Calendar ID (e.g., "primary", "user@example.com")
        name:
          type: string
          description: Display name of the calendar
        color:
          type: string
          description: Calendar color (hex code)
        is_primary:
          type: boolean
          description: Whether this is the user's primary calendar
        is_selected:
          type: boolean
          description: Whether this calendar is selected for syncing
        last_synced_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateCalendarSourcesRequest:
      type: object
      required: [calendar_ids]
      properties:
        calendar_ids:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of calendars to enable for syncing
