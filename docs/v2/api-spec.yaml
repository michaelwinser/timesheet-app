openapi: 3.0.3
info:
  title: Timesheet API
  version: 0.1.0
  description: |
    API for the Timesheet application v2.

    This is the source of truth for the API contract. All clients (Web, MCP, CLI)
    consume this spec. The Go service is generated from this spec using oapi-codegen.

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.timesheet.example.com
    description: Production

tags:
  - name: auth
    description: Authentication and session management

paths:
  /api/auth/signup:
    post:
      operationId: signup
      tags: [auth]
      summary: Create a new user account
      description: |
        Creates a new user account with email/password credentials.
        Returns session token on success.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request (missing fields, invalid email format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      operationId: login
      tags: [auth]
      summary: Authenticate with email and password
      description: |
        Authenticates a user and returns a session token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/logout:
    post:
      operationId: logout
      tags: [auth]
      summary: End the current session
      description: |
        Invalidates the current session token.
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Session ended successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/me:
    get:
      operationId: getCurrentUser
      tags: [auth]
      summary: Get current authenticated user
      description: |
        Returns the user profile for the current session.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login or signup

  schemas:
    SignupRequest:
      type: object
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: "securepassword123"
        name:
          type: string
          minLength: 1
          example: "Jane Doe"

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: "securepassword123"

    AuthResponse:
      type: object
      required:
        - token
        - user
      properties:
        token:
          type: string
          description: JWT session token
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      required:
        - id
        - email
        - name
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: "Jane Doe"
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: "invalid_credentials"
        message:
          type: string
          description: Human-readable error message
          example: "Email or password is incorrect"
        details:
          type: object
          additionalProperties: true
          description: Additional error context
