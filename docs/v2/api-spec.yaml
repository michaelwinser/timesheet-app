openapi: 3.0.3
info:
  title: Timesheet API
  version: 0.2.0
  description: |
    API for the Timesheet application v2.

    This is the source of truth for the API contract. All clients (Web, MCP, CLI)
    consume this spec. The Go service is generated from this spec using oapi-codegen.
  x-mcp:
    name: timesheet
    version: 1.0.0
    instructions: |
      You are an AI assistant helping manage a timesheet application.

      The user tracks their time across different projects. Calendar events are synced from
      Google Calendar and need to be classified (assigned to projects or marked as skipped).

      IMPORTANT: Before using search_events, create_rule, or preview_rule tools, first read the
      timesheet://docs/query-syntax resource to understand the query language.

      When helping the user:
      1. Read timesheet://docs/query-syntax to learn the search syntax
      2. List projects to understand available classification targets
      3. Search for pending events to see what needs attention
      4. Use preview_rule to test classification patterns
      5. Create rules or use bulk_classify to classify events
    resources:
      - uri: "timesheet://docs/query-syntax"
        name: "Query Syntax Reference"
        description: "Complete reference for the Gmail-style query syntax used to search events and create classification rules"
        mimeType: "text/markdown"

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.timesheet.example.com
    description: Production

tags:
  - name: auth
    description: Authentication and session management
  - name: projects
    description: Project management
  - name: time-entries
    description: Time entry tracking
  - name: calendars
    description: Calendar integration and event management
  - name: rules
    description: Classification rules for automatic event categorization
  - name: billing
    description: Billing periods and rate management
  - name: invoices
    description: Invoice generation and management

paths:
  # Auth endpoints
  /api/auth/signup:
    post:
      operationId: signup
      tags: [auth]
      summary: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      operationId: login
      tags: [auth]
      summary: Authenticate with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/logout:
    post:
      operationId: logout
      tags: [auth]
      summary: End the current session
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Session ended successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/me:
    get:
      operationId: getCurrentUser
      tags: [auth]
      summary: Get current authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Project endpoints
  /api/projects:
    get:
      operationId: listProjects
      tags: [projects]
      summary: List all projects
      description: Returns all projects for the authenticated user
      x-mcp:
        tool: list_projects
        description: "List all projects. Use this first to understand available options for classification."
      security:
        - bearerAuth: []
      parameters:
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived/inactive projects
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createProject
      tags: [projects]
      summary: Create a new project
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - short code already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/projects/{id}:
    get:
      operationId: getProject
      tags: [projects]
      summary: Get a project by ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateProject
      tags: [projects]
      summary: Update a project
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectUpdate'
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - short code already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteProject
      tags: [projects]
      summary: Delete a project
      description: Permanently deletes a project. Use archive for soft delete.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Project deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete (has time entries or invoices)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Time Entry endpoints
  /api/time-entries:
    get:
      operationId: listTimeEntries
      tags: [time-entries]
      summary: List time entries
      description: Returns time entries for the authenticated user, optionally filtered
      x-mcp:
        tool: get_time_summary
        description: "Get a summary of time entries grouped by project or date. Useful for analyzing time spent."
        custom_handler: true  # Response is aggregated/formatted differently than REST
        custom_params:
          - name: group_by
            type: string
            description: "How to group: 'project' or 'date'"
            enum: ["project", "date"]
            default: "project"
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: Start date (YYYY-MM-DD). Defaults to 7 days ago.
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: End date (YYYY-MM-DD). Defaults to today.
        - name: project_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by project
      responses:
        '200':
          description: List of time entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimeEntry'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createTimeEntry
      tags: [time-entries]
      summary: Create a new time entry
      description: Creates a manual time entry. If an entry exists for the same project/date, hours are added.
      x-mcp:
        tool: create_time_entry
        description: "Create a manual time entry for work not captured by calendar events."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeEntryCreate'
      responses:
        '201':
          description: Time entry created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/time-entries/{id}:
    get:
      operationId: getTimeEntry
      tags: [time-entries]
      summary: Get a time entry by ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Time entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateTimeEntry
      tags: [time-entries]
      summary: Update a time entry
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeEntryUpdate'
      responses:
        '200':
          description: Time entry updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot edit (entry is invoiced)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteTimeEntry
      tags: [time-entries]
      summary: Delete a time entry
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Time entry deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete (entry is invoiced)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/time-entries/{id}/refresh:
    post:
      operationId: refreshTimeEntry
      tags: [time-entries]
      summary: Reset time entry to computed values from events
      description: |
        Resets the time entry to computed values from contributing calendar events.
        - Updates hours, title, and description to computed values
        - Removes is_pinned flag (returns to auto-update mode)
        - Preserves is_locked flag
        - Clears is_stale flag
        - Cannot be used on invoiced entries
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Time entry reset to computed values
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeEntry'
        '400':
          description: Invalid request (e.g., entry is invoiced)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Time entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Calendar endpoints
  /api/auth/google/authorize:
    get:
      operationId: googleAuthorize
      tags: [calendars]
      summary: Get Google OAuth authorization URL
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OAuth URL to redirect user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthAuthorizeResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/google/callback:
    get:
      operationId: googleCallback
      tags: [calendars]
      summary: Handle Google OAuth callback
      security:
        - bearerAuth: []
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Google
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        '201':
          description: Calendar connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarConnection'
        '400':
          description: Invalid request (missing code/state)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars:
    get:
      operationId: listCalendarConnections
      tags: [calendars]
      summary: List user's calendar connections
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of calendar connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarConnection'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}:
    delete:
      operationId: deleteCalendarConnection
      tags: [calendars]
      summary: Disconnect a calendar
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Calendar disconnected
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}/sync:
    post:
      operationId: syncCalendar
      tags: [calendars]
      summary: Trigger sync for a calendar connection
      description: Syncs events from all selected calendars within this connection
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: start_date
          in: query
          required: false
          description: Start date for on-demand sync (defaults to 90 days ago)
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: false
          description: End date for on-demand sync (defaults to 30 days from now)
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResult'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendars/{id}/sources:
    get:
      operationId: listCalendarSources
      tags: [calendars]
      summary: List available calendars for a connection
      description: Returns all calendars the user has access to in this connected account
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of available calendars
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Calendar'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateCalendarSources
      tags: [calendars]
      summary: Update which calendars are selected for sync
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCalendarSourcesRequest'
      responses:
        '200':
          description: Calendar selection updated
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Calendar'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events:
    get:
      operationId: listCalendarEvents
      tags: [calendars]
      summary: List calendar events with filters
      x-mcp:
        tools:
          - tool: list_pending_events
            description: "List calendar events that need classification (assignment to a project or skip)."
            custom_handler: true
            preset_params:
              classification_status: pending
            custom_params:
              - name: limit
                type: integer
                description: "Maximum events to return"
                default: 20
          - tool: search_events
            description: "Search calendar events using query syntax. Read the timesheet://docs/query-syntax resource first to understand the query language. Use this to find events by status, project, attendees, title, etc."
            custom_handler: true
            custom_params:
              - name: query
                type: string
                description: "Query string using the search syntax (e.g., 'status:pending', 'domain:acme.com', 'title:standup'). See timesheet://docs/query-syntax resource."
              - name: limit
                type: integer
                description: "Maximum events to return (default 50)"
                default: 50
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: Start date (YYYY-MM-DD). Defaults to 30 days ago.
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: End date (YYYY-MM-DD). Defaults to today.
        - name: classification_status
          in: query
          schema:
            type: string
            enum: [pending, classified, skipped]
        - name: connection_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of calendar events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarEvent'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events/{id}/classify:
    put:
      operationId: classifyCalendarEvent
      tags: [calendars]
      summary: Classify a calendar event (assign to project or skip)
      x-mcp:
        tool: classify_event
        description: "Classify a calendar event by assigning it to a project or skipping it."
        path_params_as_input: true  # event_id comes from path parameter 'id'
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: The calendar event ID to classify
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassifyEventRequest'
      responses:
        '200':
          description: Event classified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassifyEventResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events/{id}/explain:
    get:
      operationId: explainEventClassification
      tags: [calendars]
      summary: Explain how an event was (or would be) classified
      description: |
        Shows all rules evaluated, which matched, score breakdown by project,
        and the final decision. Useful for debugging classification rules.
      x-mcp:
        tool: explain_classification
        description: "Explain how an event was (or would be) classified. Shows all rules evaluated, which matched, score breakdown by project, and the final decision. Useful for debugging why an event was classified to a particular project."
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: The calendar event ID to explain classification for
      responses:
        '200':
          description: Classification explanation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassificationExplanation'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/calendar-events/bulk-classify:
    post:
      operationId: bulkClassifyEvents
      tags: [calendars]
      summary: Bulk classify events matching a query
      description: |
        Classifies all events matching the given query to the specified project,
        or marks them as skipped. Creates time entries for classified events.
      x-mcp:
        tool: bulk_classify
        description: "Classify multiple events matching a query to a project (or skip them). More efficient than classifying one by one."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkClassifyRequest'
      responses:
        '200':
          description: Bulk classification completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkClassifyResponse'
        '400':
          description: Invalid query syntax
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Classification Rules endpoints
  /api/rules:
    get:
      operationId: listRules
      tags: [rules]
      summary: List all classification rules
      x-mcp:
        tool: list_rules
        description: "List all classification rules. Rules automatically assign events to projects based on query patterns."
      security:
        - bearerAuth: []
      parameters:
        - name: include_disabled
          in: query
          schema:
            type: boolean
            default: false
          description: Include disabled rules
      responses:
        '200':
          description: List of rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClassificationRule'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createRule
      tags: [rules]
      summary: Create a new classification rule
      x-mcp:
        tool: create_rule
        description: "Create a new classification rule. The rule will automatically classify matching events to the specified project. Read timesheet://docs/query-syntax first to understand query syntax."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreate'
      responses:
        '201':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassificationRule'
        '400':
          description: Invalid request (bad query syntax)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rules/{id}:
    get:
      operationId: getRule
      tags: [rules]
      summary: Get a rule by ID
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Rule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassificationRule'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateRule
      tags: [rules]
      summary: Update a rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleUpdate'
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClassificationRule'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteRule
      tags: [rules]
      summary: Delete a rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Rule deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rules/preview:
    post:
      operationId: previewRule
      tags: [rules]
      summary: Preview what events a rule would match
      description: |
        Evaluates a query against existing events without creating a rule.
        Returns matching events and potential conflicts with existing classifications.
      x-mcp:
        tool: preview_rule
        description: "Test a query against events to see what would match before creating a rule. Always use this before create_rule to verify the query works as expected."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RulePreviewRequest'
      responses:
        '200':
          description: Preview results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RulePreviewResponse'
        '400':
          description: Invalid query syntax
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/rules/apply:
    post:
      operationId: applyRules
      tags: [rules]
      summary: Apply classification rules to pending events
      description: |
        Runs all enabled rules against pending (unclassified) events.
        Use dry_run=true to see what would be classified without making changes.
      x-mcp:
        tool: apply_rules
        description: "Run all enabled classification rules against pending events. This applies rules to unclassified events and creates time entries."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplyRulesRequest'
      responses:
        '200':
          description: Classification results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplyRulesResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # API Keys endpoints
  /api/api-keys:
    get:
      operationId: listApiKeys
      tags: [auth]
      summary: List user's API keys
      description: Returns all API keys for the authenticated user (without the actual key values)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApiKey'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      operationId: createApiKey
      tags: [auth]
      summary: Create a new API key
      description: |
        Creates a new API key for programmatic access. The key value is only
        returned once in the response - store it securely as it cannot be retrieved again.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApiKeyCreate'
      responses:
        '201':
          description: API key created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyWithSecret'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: API key name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/api-keys/{id}:
    delete:
      operationId: deleteApiKey
      tags: [auth]
      summary: Revoke an API key
      description: Permanently deletes an API key. Any requests using this key will fail immediately.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: API key deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: API key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Billing Period endpoints
  /api/billing-periods:
    get:
      operationId: listBillingPeriods
      tags: [billing]
      summary: List billing periods for a project
      security:
        - bearerAuth: []
      parameters:
        - name: project_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of billing periods
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BillingPeriod'
        '400':

          description: Invalid request

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

    post:
      operationId: createBillingPeriod
      tags: [billing]
      summary: Create a new billing period
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingPeriodCreate'
      responses:
        '201':
          description: Billing period created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingPeriod'
        '400':

          description: Invalid request

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '409':
          description: Overlapping billing period
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/billing-periods/{id}:
    put:
      operationId: updateBillingPeriod
      tags: [billing]
      summary: Update a billing period
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingPeriodUpdate'
      responses:
        '200':
          description: Billing period updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingPeriod'
        '400':

          description: Invalid request

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '409':
          description: Overlapping billing period
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteBillingPeriod
      tags: [billing]
      summary: Delete a billing period
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Billing period deleted
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

  # Invoice endpoints
  /api/invoices:
    get:
      operationId: listInvoices
      tags: [invoices]
      summary: List invoices
      security:
        - bearerAuth: []
      parameters:
        - name: project_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, sent, paid]
      responses:
        '200':
          description: List of invoices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Invoice'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

    post:
      operationId: createInvoice
      tags: [invoices]
      summary: Generate a new invoice
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvoiceCreate'
      responses:
        '201':
          description: Invoice created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          description: No billable entries found or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

  /api/invoices/{id}:
    get:
      operationId: getInvoice
      tags: [invoices]
      summary: Get invoice details
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

    delete:
      operationId: deleteInvoice
      tags: [invoices]
      summary: Delete a draft invoice
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Invoice deleted
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '409':
          description: Cannot delete non-draft invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/invoices/{id}/status:
    put:
      operationId: updateInvoiceStatus
      tags: [invoices]
      summary: Change invoice status
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [draft, sent, paid]
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':

          description: Invalid request

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

  /api/invoices/{id}/export/csv:
    get:
      operationId: exportInvoiceCSV
      tags: [invoices]
      summary: Export invoice as CSV
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: CSV file
          content:
            text/csv:
              schema:
                type: string
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

  /api/invoices/{id}/export/sheets:
    post:
      operationId: exportInvoiceSheets
      tags: [invoices]
      summary: Export invoice to Google Sheets
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Export successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  spreadsheet_id:
                    type: string
                  spreadsheet_url:
                    type: string
                  worksheet_id:
                    type: integer
        '401':

          description: Not authenticated

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'
        '404':

          description: Not found

          content:

            application/json:

              schema:

                $ref: '#/components/schemas/Error'

  # Configuration import/export endpoints
  /api/config/export:
    get:
      operationId: exportConfig
      tags: [projects, rules]
      summary: Export projects and rules as JSON
      description: |
        Exports all projects and classification rules as a JSON file.
        Rules reference projects by name for portability across environments.
      security:
        - bearerAuth: []
      parameters:
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived projects in export
      responses:
        '200':
          description: Configuration export
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigExport'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/config/import:
    post:
      operationId: importConfig
      tags: [projects, rules]
      summary: Import projects and rules from JSON
      description: |
        Imports projects and classification rules from a JSON export.
        Projects are matched by name - existing projects are updated, new ones are created.
        Rules reference projects by name and are created/updated accordingly.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigImport'
      responses:
        '200':
          description: Import completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigImportResult'
        '400':
          description: Invalid import data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login/signup, or API key (format ts_xxx)

  schemas:
    # API Key schemas
    ApiKey:
      type: object
      required: [id, user_id, name, key_prefix, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
          description: User-provided name for this key
          example: "Claude Code"
        key_prefix:
          type: string
          description: First few characters of the key for identification
          example: "ts_a1b2c3d4"
        last_used_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    ApiKeyCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: A memorable name for this key
          example: "Claude Code"

    ApiKeyWithSecret:
      type: object
      required: [id, user_id, name, key_prefix, key, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
        key_prefix:
          type: string
        key:
          type: string
          description: |
            The full API key. This is only returned once at creation time.
            Store it securely - it cannot be retrieved again.
          example: "ts_a1b2c3d4e5f6g7h8i9j0..."
        created_at:
          type: string
          format: date-time

    # Auth schemas
    SignupRequest:
      type: object
      required: [email, password, name]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        name:
          type: string
          minLength: 1

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      required: [token, user]
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      required: [id, email, name, created_at]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        created_at:
          type: string
          format: date-time

    # Project schemas
    Project:
      type: object
      required: [id, user_id, name, color, is_billable, is_archived, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
          example: "Acme Corp Website"
        short_code:
          type: string
          maxLength: 10
          example: "ACM"
        client:
          type: string
          description: Client name for classification filtering
          example: "Acme Corp"
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          example: "#3B82F6"
        is_billable:
          type: boolean
          default: true
        is_archived:
          type: boolean
          default: false
        is_hidden_by_default:
          type: boolean
          default: false
        does_not_accumulate_hours:
          type: boolean
          default: false
        fingerprint_domains:
          type: array
          items:
            type: string
          description: Domain patterns for auto-classification (e.g., "acme.com")
        fingerprint_emails:
          type: array
          items:
            type: string
          description: Email addresses for auto-classification
        fingerprint_keywords:
          type: array
          items:
            type: string
          description: Keywords to match in event titles/descriptions
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
        short_code:
          type: string
          maxLength: 10
        client:
          type: string
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          default: "#6B7280"
        is_billable:
          type: boolean
          default: true
        is_hidden_by_default:
          type: boolean
          default: false
        does_not_accumulate_hours:
          type: boolean
          default: false
        fingerprint_domains:
          type: array
          items:
            type: string
        fingerprint_emails:
          type: array
          items:
            type: string
        fingerprint_keywords:
          type: array
          items:
            type: string

    ProjectUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        short_code:
          type: string
          maxLength: 10
        client:
          type: string
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        is_billable:
          type: boolean
        is_archived:
          type: boolean
        is_hidden_by_default:
          type: boolean
        does_not_accumulate_hours:
          type: boolean
        fingerprint_domains:
          type: array
          items:
            type: string
        fingerprint_emails:
          type: array
          items:
            type: string
        fingerprint_keywords:
          type: array
          items:
            type: string

    # Time Entry schemas
    TimeEntry:
      type: object
      required: [id, user_id, project_id, date, hours, source, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        project:
          $ref: '#/components/schemas/Project'
          description: Included when fetching entries
        date:
          type: string
          format: date
          description: The calendar day for this entry
        hours:
          type: number
          format: float
          minimum: 0
          example: 2.5
        title:
          type: string
          description: Short title (generated from events or user-provided)
        description:
          type: string
          example: "Worked on API design"
        source:
          type: string
          enum: [manual, calendar, import]
          description: How this entry was created
        invoice_id:
          type: string
          format: uuid
          nullable: true
          description: If invoiced, the invoice ID
        has_user_edits:
          type: boolean
          default: false
          description: Whether user has modified this entry
        # Protection model fields
        is_pinned:
          type: boolean
          default: false
          description: Entry is pinned (user has edited it)
        is_locked:
          type: boolean
          default: false
          description: Entry is locked (via Lock Day/Week)
        is_stale:
          type: boolean
          default: false
          description: Computed values differ from current values
        is_suppressed:
          type: boolean
          default: false
          description: User explicitly suppressed this entry
        # Computed fields
        computed_hours:
          type: number
          format: float
          description: Latest calculated hours from events
        computed_title:
          type: string
          description: Generated title from events
        computed_description:
          type: string
          description: Generated description from events
        snapshot_computed_hours:
          type: number
          format: float
          description: Computed hours at the time of materialization (for staleness detection)
        calculation_details:
          $ref: '#/components/schemas/CalculationDetails'
        contributing_events:
          type: array
          items:
            type: string
            format: uuid
          description: Event IDs that contribute to this entry
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CalculationDetails:
      type: object
      description: Audit trail showing how hours were calculated
      properties:
        events:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              title:
                type: string
              start:
                type: string
              end:
                type: string
              raw_minutes:
                type: integer
              is_all_day:
                type: boolean
        time_ranges:
          type: array
          items:
            type: object
            properties:
              start:
                type: string
              end:
                type: string
              minutes:
                type: integer
        union_minutes:
          type: integer
        rounding_applied:
          type: string
        final_minutes:
          type: integer

    TimeEntryCreate:
      type: object
      required: [project_id, date, hours]
      properties:
        project_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        hours:
          type: number
          format: float
          minimum: 0
        description:
          type: string

    TimeEntryUpdate:
      type: object
      properties:
        hours:
          type: number
          format: float
          minimum: 0
        description:
          type: string
        project_id:
          type: string
          format: uuid
          description: Required when updating an ephemeral entry (to materialize it)
        date:
          type: string
          format: date
          description: Required when updating an ephemeral entry (to materialize it)

    # Common schemas
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    # Calendar schemas
    OAuthAuthorizeResponse:
      type: object
      required: [url, state]
      properties:
        url:
          type: string
          format: uri
          description: URL to redirect user for OAuth consent
        state:
          type: string
          description: State token for CSRF protection

    CalendarConnection:
      type: object
      required: [id, user_id, provider, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [google]
        last_synced_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CalendarEvent:
      type: object
      required: [id, connection_id, user_id, external_id, title, start_time, end_time, classification_status, created_at]
      properties:
        id:
          type: string
          format: uuid
        connection_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        external_id:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        attendees:
          type: array
          items:
            type: string
        is_recurring:
          type: boolean
        is_all_day:
          type: boolean
          description: Whether this is an all-day event (no specific start/end times)
        response_status:
          type: string
          nullable: true
        transparency:
          type: string
          nullable: true
        is_orphaned:
          type: boolean
        is_suppressed:
          type: boolean
        classification_status:
          type: string
          enum: [pending, classified]
        is_skipped:
          type: boolean
          description: Whether this event is marked as skipped (excluded from time entries)
        classification_source:
          type: string
          enum: [rule, fingerprint, manual, llm]
          nullable: true
        classification_confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          nullable: true
          description: Confidence score from rule-based classification
        needs_review:
          type: boolean
          description: True if event was auto-classified with medium confidence and should be reviewed
        project_id:
          type: string
          format: uuid
          nullable: true
        project:
          $ref: '#/components/schemas/Project'
        calendar_id:
          type: string
          nullable: true
          description: Google Calendar ID (typically the calendar email, e.g., "user@example.com" or "primary")
        calendar_name:
          type: string
          nullable: true
          description: Name of the source calendar
        calendar_color:
          type: string
          nullable: true
          description: Color of the source calendar (hex code)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SyncResult:
      type: object
      required: [events_created, events_updated, events_orphaned]
      properties:
        events_created:
          type: integer
        events_updated:
          type: integer
        events_orphaned:
          type: integer

    ClassifyEventRequest:
      type: object
      description: |
        Classify an event by assigning it to a project, skipping it, or unskipping it.
        - To assign to project: provide project_id
        - To skip (mark as "did not attend"): set skip to true
        - To unskip (reset to pending): set skip to false with no project_id
      properties:
        project_id:
          type: string
          format: uuid
          description: Project to assign this event to.
        skip:
          type: boolean
          description: Set to true to skip, or false to unskip (reset to pending state).

    ClassifyEventResponse:
      type: object
      required: [event]
      properties:
        event:
          $ref: '#/components/schemas/CalendarEvent'
        time_entry:
          $ref: '#/components/schemas/TimeEntry'
          description: The created or updated time entry (only when classifying to a project)

    BulkClassifyRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: Gmail-style query to match events (e.g., "domain:acme.com title:sync")
        project_id:
          type: string
          format: uuid
          description: Project to assign matching events to. Omit to skip events.
        skip:
          type: boolean
          default: false
          description: If true, mark matching events as skipped (did not attend)

    BulkClassifyResponse:
      type: object
      required: [classified_count, skipped_count]
      properties:
        classified_count:
          type: integer
          description: Number of events classified to a project
        skipped_count:
          type: integer
          description: Number of events marked as skipped
        time_entries_created:
          type: integer
          description: Number of time entries created

    ClassificationExplanation:
      type: object
      required: [event, outcome, target_scores, rule_evaluations]
      properties:
        event:
          $ref: '#/components/schemas/CalendarEvent'
        outcome:
          type: string
          description: Human-readable summary of classification decision
        would_be_skipped:
          type: boolean
          description: Whether skip rules would mark this event as skipped
        skip_confidence:
          type: number
          format: float
          description: Confidence of skip decision (0-1)
        winner_project_id:
          type: string
          format: uuid
          nullable: true
          description: Project ID of the winning classification
        winner_confidence:
          type: number
          format: float
          description: Confidence of the winning classification (0-1)
        total_weight:
          type: number
          format: float
          description: Sum of all matching rule weights
        target_scores:
          type: array
          items:
            $ref: '#/components/schemas/TargetScore'
          description: Score breakdown by project
        rule_evaluations:
          type: array
          items:
            $ref: '#/components/schemas/RuleEvaluation'
          description: All project rules evaluated
        skip_evaluations:
          type: array
          items:
            $ref: '#/components/schemas/RuleEvaluation'
          description: All skip rules evaluated

    TargetScore:
      type: object
      required: [target_id, total_weight]
      properties:
        target_id:
          type: string
          format: uuid
          description: Project ID
        target_name:
          type: string
          description: Project name
        total_weight:
          type: number
          format: float
          description: Total accumulated weight for this project
        rule_weight:
          type: number
          format: float
          description: Weight from explicit user-defined rules
        fingerprint_weight:
          type: number
          format: float
          description: Weight from project fingerprint matches
        is_winner:
          type: boolean
          description: Whether this project won the classification

    RuleEvaluation:
      type: object
      required: [query, matched]
      properties:
        rule_id:
          type: string
          description: Rule identifier
        query:
          type: string
          description: The rule query pattern
        target_id:
          type: string
          description: Target project ID or "skip"
        target_name:
          type: string
          description: Target project name
        weight:
          type: number
          format: float
          description: Rule weight
        source:
          type: string
          enum: [rule, fingerprint]
          description: Whether from explicit rule or fingerprint
        matched:
          type: boolean
          description: Whether this rule matched the event

    Calendar:
      type: object
      required: [id, connection_id, external_id, name, is_primary, is_selected, created_at]
      properties:
        id:
          type: string
          format: uuid
        connection_id:
          type: string
          format: uuid
        external_id:
          type: string
          description: Google Calendar ID (e.g., "primary", "user@example.com")
        name:
          type: string
          description: Display name of the calendar
        color:
          type: string
          description: Calendar color (hex code)
        is_primary:
          type: boolean
          description: Whether this is the user's primary calendar
        is_selected:
          type: boolean
          description: Whether this calendar is selected for syncing
        last_synced_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateCalendarSourcesRequest:
      type: object
      required: [calendar_ids]
      properties:
        calendar_ids:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of calendars to enable for syncing

    # Classification Rule schemas
    ClassificationRule:
      type: object
      required: [id, user_id, query, weight, is_enabled, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        query:
          type: string
          description: Gmail-style query (e.g., "domain:acme.com title:standup")
          example: 'domain:acme.com title:"weekly sync"'
        project_id:
          type: string
          format: uuid
          nullable: true
          description: Target project for matching events (null for attendance rules)
        project_name:
          type: string
          nullable: true
          description: Name of target project (joined for convenience)
        project_color:
          type: string
          nullable: true
          description: Color of target project (joined for convenience)
        attended:
          type: boolean
          nullable: true
          description: For attendance rules - true=attended, false=did not attend
        weight:
          type: number
          format: float
          minimum: 0
          default: 1.0
          description: Rule weight for scoring (higher = stronger vote)
        is_enabled:
          type: boolean
          default: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    RuleCreate:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: Gmail-style query string
          example: 'title:standup domain:acme.com'
        project_id:
          type: string
          format: uuid
          description: Target project (required unless attended is set)
        attended:
          type: boolean
          description: For attendance rules - false means "did not attend"
        weight:
          type: number
          format: float
          minimum: 0
          default: 1.0
        is_enabled:
          type: boolean
          default: true

    RuleUpdate:
      type: object
      properties:
        query:
          type: string
        project_id:
          type: string
          format: uuid
          nullable: true
        attended:
          type: boolean
          nullable: true
        weight:
          type: number
          format: float
          minimum: 0
        is_enabled:
          type: boolean

    RulePreviewRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: Query to preview
        project_id:
          type: string
          format: uuid
          description: Target project (for conflict detection)
        start_date:
          type: string
          format: date
          description: Start of date range to search
        end_date:
          type: string
          format: date
          description: End of date range to search

    RulePreviewResponse:
      type: object
      required: [matches, conflicts, stats]
      properties:
        matches:
          type: array
          items:
            $ref: '#/components/schemas/MatchedEvent'
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/RuleConflict'
        stats:
          $ref: '#/components/schemas/PreviewStats'

    MatchedEvent:
      type: object
      required: [event_id, title, start_time]
      properties:
        event_id:
          type: string
          format: uuid
        title:
          type: string
        start_time:
          type: string
          format: date-time

    RuleConflict:
      type: object
      required: [event_id]
      properties:
        event_id:
          type: string
          format: uuid
        current_project_id:
          type: string
          format: uuid
          nullable: true
        current_source:
          type: string
          description: How the event was classified (manual, rule, llm)
        proposed_project_id:
          type: string
          format: uuid
          nullable: true

    PreviewStats:
      type: object
      required: [total_matches, already_correct, would_change, manual_conflicts]
      properties:
        total_matches:
          type: integer
        already_correct:
          type: integer
          description: Events already classified to the target project
        would_change:
          type: integer
          description: Events that would be reclassified
        manual_conflicts:
          type: integer
          description: Events with manual classifications that conflict

    ApplyRulesRequest:
      type: object
      properties:
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        dry_run:
          type: boolean
          default: false
          description: If true, return what would be classified without making changes

    ApplyRulesResponse:
      type: object
      required: [classified, skipped]
      properties:
        classified:
          type: array
          items:
            $ref: '#/components/schemas/ClassifiedEvent'
        skipped:
          type: integer
          description: Events that matched no rules or were below confidence threshold

    ClassifiedEvent:
      type: object
      required: [event_id, project_id, confidence, needs_review]
      properties:
        event_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        needs_review:
          type: boolean
          description: True if confidence is between floor and ceiling thresholds

    BillingPeriod:
      type: object
      required: [id, user_id, project_id, starts_on, hourly_rate, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        starts_on:
          type: string
          format: date
          description: Start date of the billing period
        ends_on:
          type: string
          format: date
          nullable: true
          description: End date of the billing period (null means ongoing)
        hourly_rate:
          type: number
          format: float
          minimum: 0
          description: Hourly rate for this period
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BillingPeriodCreate:
      type: object
      required: [project_id, starts_on, hourly_rate]
      properties:
        project_id:
          type: string
          format: uuid
        starts_on:
          type: string
          format: date
          description: Start date in YYYY-MM-DD format
        ends_on:
          type: string
          format: date
          nullable: true
          description: End date in YYYY-MM-DD format (omit or null for ongoing)
        hourly_rate:
          type: number
          format: float
          minimum: 0

    BillingPeriodUpdate:
      type: object
      properties:
        starts_on:
          type: string
          format: date
        ends_on:
          type: string
          format: date
          nullable: true
          description: Set to empty string to clear (make ongoing)
        hourly_rate:
          type: number
          format: float
          minimum: 0

    Invoice:
      type: object
      required: [id, user_id, project_id, invoice_number, period_start, period_end, invoice_date, status, total_hours, total_amount, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        project:
          $ref: '#/components/schemas/Project'
          description: Joined project data
        billing_period_id:
          type: string
          format: uuid
          nullable: true
          description: Primary billing period for this invoice
        invoice_number:
          type: string
          description: Auto-generated invoice number (PROJECT-YEAR-SEQ)
          example: ACME-2026-001
        period_start:
          type: string
          format: date
          description: Start date of invoiced period
        period_end:
          type: string
          format: date
          description: End date of invoiced period
        invoice_date:
          type: string
          format: date
          description: Date invoice was created
        status:
          type: string
          enum: [draft, sent, paid]
          description: Invoice status
        total_hours:
          type: number
          format: float
          description: Total billable hours
        total_amount:
          type: number
          format: float
          description: Total invoice amount
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceLineItem'
          description: Invoice line items (included in detail view)
        spreadsheet_id:
          type: string
          nullable: true
          description: Google Sheets spreadsheet ID
        spreadsheet_url:
          type: string
          nullable: true
          description: Full URL to Google Sheets
        worksheet_id:
          type: integer
          nullable: true
          description: Sheet ID within the spreadsheet
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    InvoiceLineItem:
      type: object
      required: [id, invoice_id, time_entry_id, date, description, hours, hourly_rate, amount]
      properties:
        id:
          type: string
          format: uuid
        invoice_id:
          type: string
          format: uuid
        time_entry_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
          description: Date of the work
        description:
          type: string
          description: Work description from time entry
        hours:
          type: number
          format: float
          description: Hours worked
        hourly_rate:
          type: number
          format: float
          description: Rate at time of invoice creation (snapshot)
        amount:
          type: number
          format: float
          description: Calculated amount (hours * hourly_rate)

    InvoiceCreate:
      type: object
      required: [project_id, period_start, period_end]
      properties:
        project_id:
          type: string
          format: uuid
        period_start:
          type: string
          format: date
          description: Start date for unbilled entries (YYYY-MM-DD)
        period_end:
          type: string
          format: date
          description: End date for unbilled entries (YYYY-MM-DD)
        invoice_date:
          type: string
          format: date
          description: Invoice date (defaults to today if omitted)

    InvoiceStatusUpdate:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [draft, sent, paid]
          description: New status for the invoice

    # Configuration import/export schemas
    ConfigExport:
      type: object
      required: [version, exported_at, projects, rules]
      properties:
        version:
          type: string
          description: Export format version
          example: "1"
        exported_at:
          type: string
          format: date-time
          description: When this export was created
        projects:
          type: array
          items:
            $ref: '#/components/schemas/ProjectExport'
          description: All projects in the export
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleExport'
          description: All classification rules in the export

    ConfigImport:
      type: object
      required: [projects, rules]
      properties:
        version:
          type: string
          description: Export format version (optional, for compatibility)
        projects:
          type: array
          items:
            $ref: '#/components/schemas/ProjectExport'
          description: Projects to import
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleExport'
          description: Rules to import

    ConfigImportResult:
      type: object
      required: [projects_created, projects_updated, rules_created, rules_updated]
      properties:
        projects_created:
          type: integer
          description: Number of new projects created
        projects_updated:
          type: integer
          description: Number of existing projects updated
        rules_created:
          type: integer
          description: Number of new rules created
        rules_updated:
          type: integer
          description: Number of existing rules updated
        rules_skipped:
          type: integer
          description: Number of rules skipped (e.g., project not found)
        warnings:
          type: array
          items:
            type: string
          description: Any warnings during import

    ProjectExport:
      type: object
      required: [name]
      description: Project data for export/import (name is the unique identifier)
      properties:
        name:
          type: string
          description: Project name (used as unique identifier)
        short_code:
          type: string
          maxLength: 10
        client:
          type: string
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        is_billable:
          type: boolean
        is_archived:
          type: boolean
        is_hidden_by_default:
          type: boolean
        does_not_accumulate_hours:
          type: boolean
        fingerprint_domains:
          type: array
          items:
            type: string
        fingerprint_emails:
          type: array
          items:
            type: string
        fingerprint_keywords:
          type: array
          items:
            type: string

    RuleExport:
      type: object
      required: [query]
      description: Classification rule for export/import (references projects by name)
      properties:
        query:
          type: string
          description: Gmail-style query string
        project_name:
          type: string
          description: Target project name (instead of ID for portability)
        skip:
          type: boolean
          description: If true, this is a skip rule (attended=false)
        weight:
          type: number
          format: float
          minimum: 0
        is_enabled:
          type: boolean
