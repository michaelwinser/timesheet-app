{% extends "base.html" %}

{% block title %}Week of {{ week_start.strftime('%b %d') }} - Timesheet{% endblock %}

{% block main_class %}full-width{% endblock %}

{% block content %}
<div class="week-header">
    <div class="week-nav">
        <a href="/week/{{ prev_week }}" class="btn btn-secondary">&larr; Prev</a>
        <a href="/" class="btn btn-secondary">Today</a>
        <a href="/week/{{ next_week }}" class="btn btn-secondary">Next &rarr;</a>
    </div>
    <h1 class="week-title">Week of {{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}</h1>
    <div class="week-actions">
        <button id="sync-btn" class="btn btn-secondary" onclick="refreshEvents()">↻ Refresh</button>
        <a href="/api/export/harvest?start_date={{ week_start }}&end_date={{ week_end }}" class="btn btn-primary">Export CSV</a>
    </div>
</div>

<div class="filter-bar">
    <input type="text" id="filter-input" placeholder="Filter events..." onkeyup="filterEvents()">
</div>

<div class="week-container">
<div class="week-grid">
    {% for day in days %}
    <div class="day-column {% if day.is_today %}today{% endif %}">
        <div class="day-header">
            <span class="day-name">{{ day.day_name }}</span>
            <span class="day-number">{{ day.day_number }}</span>
        </div>
        <div class="day-events">
            {% for event in day.events %}
            <div class="event-card {% if event.is_classified %}classified{% else %}unclassified{% endif %} {% if event.did_not_attend %}did-not-attend{% endif %}"
                 data-event-id="{{ event.id }}"
                 data-title="{{ event.title }}"
                 data-description="{{ event.description or '' }}"
                 data-attendees="{{ event.attendees | join(', ') if event.attendees else '' }}"
                 data-project="{{ event.project_name or '' }}"
                 data-did-not-attend="{{ 'true' if event.did_not_attend else 'false' }}"
                 data-google-event-id="{{ event.google_event_id or '' }}">

                <!-- Event side (unclassified view) -->
                <div class="card-side card-event {% if event.is_classified %}hidden{% endif %}"
                     data-project-color="{{ event.project_color or '' }}">
                    <!-- Row 1: Title with tooltip + calendar link -->
                    <div class="card-row-title">
                        <span class="title-text title-tooltip">
                            {{ event.title }}
                            <div class="tooltip-content">
                                <strong>{{ event.title }}</strong>
                                {% if event.my_response_status %}
                                <div class="tooltip-row"><span class="tooltip-label">My status:</span> {{ event.my_response_status }}</div>
                                {% endif %}
                                {% if event.attendees %}
                                <div class="tooltip-row"><span class="tooltip-label">Attendees:</span> {{ event.attendees | join(', ') }}</div>
                                {% endif %}
                                {% if event.description %}
                                <div class="tooltip-row"><span class="tooltip-label">Description:</span> {{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</div>
                                {% endif %}
                            </div>
                        </span>
                        {% if event.google_event_id %}
                        <a href="https://calendar.google.com/calendar/event?eid={{ event.google_event_id }}" class="btn-calendar-link" title="Open in Google Calendar" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                    <!-- Row 2: Project dropdown -->
                    <div class="card-row-project">
                        <select onchange="classifyEvent({{ event.id }}, this.value, this.options[this.selectedIndex].dataset.color)" {% if event.did_not_attend %}disabled{% endif %}>
                            <option value="">Select project...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Row 3: Time -->
                    <div class="card-row-time">
                        <span>{{ event.start_time[11:16] }} - {{ event.end_time[11:16] }}</span>
                        {% if event.my_response_status and event.my_response_status != 'accepted' %}
                        <span class="response-status" title="Response: {{ event.my_response_status }}">
                            {% if event.my_response_status == 'declined' %}✗{% elif event.my_response_status == 'tentative' %}?{% elif event.my_response_status == 'needsAction' %}•{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    <!-- Row 4: Actions -->
                    <div class="card-row-actions">
                        <label class="checkbox-dna">
                            <input type="checkbox" {% if event.did_not_attend %}checked{% endif %} onchange="toggleDidNotAttend({{ event.id }})"> DNA
                        </label>
                        <button class="btn-icon" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">&#9881;</button>
                    </div>
                    {% if event.is_classified %}
                    <div class="dog-ear" onclick="flipCard({{ event.id }})" title="Flip to time entry">
                        <svg class="flip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M17 1l4 4-4 4"></path>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                            <path d="M7 23l-4-4 4-4"></path>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                        </svg>
                    </div>
                    {% endif %}
                </div>

                <!-- Time entry side (classified view) -->
                <div class="card-side card-entry {% if not event.is_classified %}hidden{% endif %}"
                     data-entry-id="{{ event.entry_id }}"
                     style="background-color: {{ event.project_color }}">
                    <!-- Row 1: Title with tooltip + calendar link -->
                    <div class="card-row-title">
                        <span class="title-text title-tooltip">
                            {{ event.title }}
                            <div class="tooltip-content">
                                <strong>{{ event.title }}</strong>
                                {% if event.my_response_status %}
                                <div class="tooltip-row"><span class="tooltip-label">My status:</span> {{ event.my_response_status }}</div>
                                {% endif %}
                                {% if event.attendees %}
                                <div class="tooltip-row"><span class="tooltip-label">Attendees:</span> {{ event.attendees | join(', ') }}</div>
                                {% endif %}
                                {% if event.description %}
                                <div class="tooltip-row"><span class="tooltip-label">Description:</span> {{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</div>
                                {% endif %}
                            </div>
                        </span>
                        {% if event.google_event_id %}
                        <a href="https://calendar.google.com/calendar/event?eid={{ event.google_event_id }}" class="btn-calendar-link" title="Open in Google Calendar" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                    <!-- Row 2: Project dropdown -->
                    <div class="card-row-project">
                        <select onchange="reclassifyEvent({{ event.id }}, {{ event.entry_id }}, this.value, this.options[this.selectedIndex].dataset.color)">
                            <option value="">— Unclassify —</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}" {% if project.id == event.project_id %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Row 3: Duration with +15m -->
                    <div class="card-row-time">
                        <input type="text" class="duration-input" value="{{ '%.2f'|format(event.hours or 0) }}" data-entry-id="{{ event.entry_id }}" onchange="updateHours({{ event.entry_id }}, this.value)">
                        <span>hrs</span>
                        <button class="btn-round" onclick="roundUp({{ event.id }}, {{ event.entry_id }})">+15m</button>
                    </div>
                    <!-- Row 4: Actions -->
                    <div class="card-row-actions">
                        {% if event.invoice_id %}
                        <a href="/invoices" class="badge badge-billed" title="Billed: {{ event.invoice_number }}">$</a>
                        {% endif %}
                        <label class="checkbox-dna">
                            <input type="checkbox" {% if event.did_not_attend %}checked{% endif %} onchange="toggleDidNotAttend({{ event.id }})"> DNA
                        </label>
                        <button class="btn-icon" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">&#9881;</button>
                    </div>
                    <div class="dog-ear" onclick="flipCard({{ event.id }})" title="Flip to event">
                        <svg class="flip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M17 1l4 4-4 4"></path>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                            <path d="M7 23l-4-4 4-4"></path>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                        </svg>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-events">No events</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<aside class="project-summary-sidebar">
    <h3>Project Summary</h3>
    <div class="summary-total">{{ "%.1f"|format(total_hours) }} hrs total</div>

    <!-- Regular Projects -->
    <div class="summary-section">
        <div class="summary-section-header">Projects</div>
        <div class="summary-list">
            {% for proj in regular_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox" checked
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
                {% if total_hours > 0 and not proj.does_not_accumulate_hours %}
                <div class="summary-bar">
                    <div class="summary-bar-fill" style="width: {{ (proj.hours / total_hours * 100)|int }}%; background-color: {{ proj.color }}"></div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Hidden Projects (collapsed by default) -->
    {% if hidden_projects %}
    <div class="summary-section hidden-section" id="hidden-section">
        <div class="summary-section-header collapsible" onclick="toggleHiddenSection()">
            <span class="collapse-icon">▶</span>
            Hidden ({{ hidden_projects|length }})
            <span class="section-total">{{ "%.1f"|format(hidden_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list hidden" id="hidden-projects-list">
            {% for proj in hidden_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox"
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Archived Projects (only shown if they have entries in current view) -->
    {% if archived_projects %}
    <div class="summary-section archived-section">
        <div class="summary-section-header warning">
            <span class="warning-icon">⚠</span>
            Archived ({{ archived_projects|length }})
            <span class="section-total">{{ "%.1f"|format(archived_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list">
            {% for proj in archived_projects %}
            <div class="summary-item archived" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox"
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
            </div>
            {% endfor %}
        </div>
        <p class="archived-hint">These entries need reclassification.</p>
    </div>
    {% endif %}
</aside>
</div>
<!-- Create Rule Modal -->
<div id="rule-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Create Rule from Event</h2>
        <div id="rule-modal-loading">Loading event properties...</div>
        <div id="rule-modal-form" class="hidden">
            <div class="form-row">
                <label for="modal-rule-name">Rule Name:</label>
                <input type="text" id="modal-rule-name" placeholder="e.g., Client meetings">
            </div>

            <div class="form-row">
                <label for="modal-target-type">Action:</label>
                <select id="modal-target-type" onchange="toggleModalProjectSelect()">
                    <option value="project">Classify to Project</option>
                    <option value="did_not_attend">Mark as Did Not Attend</option>
                </select>
            </div>

            <div class="form-row" id="modal-project-row">
                <label for="modal-rule-project">Project:</label>
                <select id="modal-rule-project">
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label for="modal-rule-priority">Priority:</label>
                <input type="number" id="modal-rule-priority" value="50" min="0" max="100">
                <span class="form-hint">Higher = evaluated first</span>
            </div>

            <div class="event-properties-section">
                <h3>Event Properties</h3>
                <p class="form-hint">Select properties to use as conditions for this rule. The current values from this event will be pre-filled.</p>
                <div id="modal-properties-list"></div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveRuleFromModal()">Create Rule</button>
                <button class="btn btn-secondary" onclick="hideRuleModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
<script>
    // Initialize with current week dates
    window.weekStart = "{{ week_start }}";
    window.weekEnd = "{{ week_end }}";

    // Auto-sync, auto-classify, and restore visibility preferences on page load
    document.addEventListener('DOMContentLoaded', async function() {
        syncEventsQuiet();
        await autoClassifyEvents();
        restoreProjectVisibility();
    });

    /**
     * Auto-classify unclassified events using rules.
     * Reloads page if any events were classified.
     */
    async function autoClassifyEvents() {
        // Prevent reload loops
        if (sessionStorage.getItem('justClassified') === window.location.pathname) {
            sessionStorage.removeItem('justClassified');
            return;
        }

        try {
            const result = await api.applyRules(window.weekStart, window.weekEnd);
            if (result.classified > 0) {
                sessionStorage.setItem('justClassified', window.location.pathname);
                location.reload();
            }
        } catch (error) {
            console.error('Auto-classify failed:', error.message);
        }
    }

    /**
     * Restore project visibility preferences from sessionStorage.
     */
    function restoreProjectVisibility() {
        const visibilityKey = `projectVisibility_${window.weekStart}`;
        const visibility = JSON.parse(sessionStorage.getItem(visibilityKey) || '{}');

        for (const [projectId, isVisible] of Object.entries(visibility)) {
            if (!isVisible) {
                // Update checkbox state
                const checkbox = document.querySelector(`.summary-item[data-project-id="${projectId}"] input[type="checkbox"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    // Trigger visibility update
                    toggleProjectVisibility(parseInt(projectId), false);
                }
            }
        }
    }

    // Rule creation from event
    let currentEventId = null;
    let propertyDefinitions = [];
    let conditionTypes = [];

    /**
     * Toggle project select visibility based on target type.
     */
    function toggleModalProjectSelect() {
        const targetType = document.getElementById('modal-target-type').value;
        const projectRow = document.getElementById('modal-project-row');
        if (targetType === 'did_not_attend') {
            projectRow.classList.add('hidden');
        } else {
            projectRow.classList.remove('hidden');
        }
    }

    /**
     * Show the create rule modal for an event.
     */
    async function showCreateRuleModal(eventId) {
        currentEventId = eventId;
        const modal = document.getElementById('rule-modal');
        const loading = document.getElementById('rule-modal-loading');
        const form = document.getElementById('rule-modal-form');

        // Get the event card to check current project
        const card = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const currentProjectId = card?.querySelector('.card-entry')?.dataset?.entryId
            ? card.querySelector('.entry-project-select')?.value
            : null;

        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        form.classList.add('hidden');

        try {
            // Fetch property definitions, condition types, and event properties in parallel
            const [propDefs, condTypes, eventProps] = await Promise.all([
                api.get('/api/properties'),
                api.get('/api/conditions'),
                api.get(`/api/events/${eventId}/properties`)
            ]);

            propertyDefinitions = propDefs;
            conditionTypes = condTypes;

            // Pre-fill rule name with event title
            const eventTitle = eventProps.title || 'Untitled';
            document.getElementById('modal-rule-name').value = `${eventTitle} Rule`;

            // Reset target type to project and show project row
            document.getElementById('modal-target-type').value = 'project';
            toggleModalProjectSelect();

            // Pre-select the event's current project if classified
            if (currentProjectId) {
                document.getElementById('modal-rule-project').value = currentProjectId;
            }

            // Build the properties list with checkboxes
            const listContainer = document.getElementById('modal-properties-list');
            listContainer.innerHTML = '';

            for (const prop of propertyDefinitions) {
                const currentValue = eventProps[prop.name];
                // Skip properties with no value
                if (currentValue === null || currentValue === undefined || currentValue === '' ||
                    (Array.isArray(currentValue) && currentValue.length === 0)) {
                    continue;
                }

                const row = document.createElement('div');
                row.className = 'property-row';

                // Get applicable condition types for this property
                const applicableConditions = conditionTypes.filter(c =>
                    c.applies_to.includes(prop.value_type)
                );

                // Format the current value for display
                let displayValue = currentValue;
                if (Array.isArray(currentValue)) {
                    displayValue = currentValue.join(', ');
                }

                row.innerHTML = `
                    <label class="property-checkbox">
                        <input type="checkbox" class="prop-check" data-property="${prop.name}" data-type="${prop.value_type}">
                        <span class="prop-name">${prop.display_name}</span>
                    </label>
                    <select class="prop-condition" disabled>
                        ${applicableConditions.map(c => `<option value="${c.type}">${c.display}</option>`).join('')}
                    </select>
                    <input type="text" class="prop-value" value="${escapeHtml(String(displayValue))}" disabled>
                `;

                // Enable/disable condition and value when checkbox is toggled
                const checkbox = row.querySelector('.prop-check');
                const condSelect = row.querySelector('.prop-condition');
                const valueInput = row.querySelector('.prop-value');

                checkbox.addEventListener('change', () => {
                    condSelect.disabled = !checkbox.checked;
                    valueInput.disabled = !checkbox.checked;
                });

                listContainer.appendChild(row);
            }

            loading.classList.add('hidden');
            form.classList.remove('hidden');

        } catch (error) {
            alert('Error loading event properties: ' + error.message);
            hideRuleModal();
        }
    }

    /**
     * Hide the rule creation modal.
     */
    function hideRuleModal() {
        document.getElementById('rule-modal').classList.add('hidden');
        currentEventId = null;
    }

    /**
     * Save the rule from the modal form.
     */
    async function saveRuleFromModal() {
        const name = document.getElementById('modal-rule-name').value.trim();
        const targetType = document.getElementById('modal-target-type').value;
        const projectId = parseInt(document.getElementById('modal-rule-project').value);
        const priority = parseInt(document.getElementById('modal-rule-priority').value);

        if (!name) {
            alert('Rule name is required');
            return;
        }

        // Gather selected conditions
        const conditions = [];
        const rows = document.querySelectorAll('.property-row');
        for (const row of rows) {
            const checkbox = row.querySelector('.prop-check');
            if (!checkbox.checked) continue;

            const propertyName = checkbox.dataset.property;
            const conditionType = row.querySelector('.prop-condition').value;
            let conditionValue = row.querySelector('.prop-value').value;

            // Convert comma-separated values to array for list types
            const propType = checkbox.dataset.type;
            if (propType === 'list' || conditionType === 'in_list') {
                conditionValue = conditionValue.split(',').map(v => v.trim()).filter(v => v);
            }

            conditions.push({
                property_name: propertyName,
                condition_type: conditionType,
                condition_value: conditionValue
            });
        }

        if (conditions.length === 0) {
            alert('At least one condition is required. Please select a property.');
            return;
        }

        try {
            const ruleData = {
                name,
                target_type: targetType,
                priority,
                is_enabled: true,
                conditions
            };

            // Only include project_id for project rules
            if (targetType === 'project') {
                ruleData.project_id = projectId;
            }

            await api.post('/api/rules', ruleData);

            showToast('Rule created successfully!', 'success');
            hideRuleModal();

        } catch (error) {
            showToast('Error creating rule: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML for safe display.
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('rule-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideRuleModal();
        }
    });

    /**
     * Toggle the hidden projects section in sidebar.
     */
    function toggleHiddenSection() {
        const list = document.getElementById('hidden-projects-list');
        const icon = document.querySelector('#hidden-section .collapse-icon');
        if (list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            icon.textContent = '▼';
        } else {
            list.classList.add('hidden');
            icon.textContent = '▶';
        }
    }

    /**
     * Toggle the did_not_attend flag for an event.
     */
    async function toggleDidNotAttend(eventId) {
        const card = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const currentValue = card.dataset.didNotAttend === 'true';
        const newValue = !currentValue;

        try {
            await api.put(`/api/events/${eventId}/attendance`, { did_not_attend: newValue });

            // Update the UI
            card.dataset.didNotAttend = newValue ? 'true' : 'false';
            if (newValue) {
                card.classList.add('did-not-attend');
            } else {
                card.classList.remove('did-not-attend');
            }

            // Update all DNA checkboxes on this card (both event side and entry side)
            const checkboxes = card.querySelectorAll('.checkbox-dna input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = newValue);

            // Disable/enable the project selects
            const selects = card.querySelectorAll('.card-row-project select');
            selects.forEach(select => {
                // Only disable on event side, entry side can still reclassify
                if (select.closest('.card-event')) {
                    select.disabled = newValue;
                }
            });

            showToast(newValue ? 'Marked as did not attend' : 'Marked as attended', 'success');

        } catch (error) {
            showToast('Error updating attendance: ' + error.message, 'error');
            // Revert checkbox state on error
            const checkboxes = card.querySelectorAll('.checkbox-dna input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = currentValue);
        }
    }
</script>
{% endblock %}
