{% extends "base.html" %}

{% block title %}Week of {{ week_start.strftime('%b %d') }} - Timesheet{% endblock %}

{% block main_class %}full-width{% endblock %}

{% block content %}
<div class="week-header">
    <div class="week-nav">
        <a href="/week/{{ prev_week }}" class="btn btn-secondary">&larr; Prev</a>
        <a href="/" class="btn btn-secondary">Today</a>
        <a href="/week/{{ next_week }}" class="btn btn-secondary">Next &rarr;</a>
    </div>
    <h1 class="week-title">Week of {{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}</h1>
    <div class="week-actions">
        <button id="sync-btn" class="btn btn-secondary" onclick="refreshEvents()">↻ Refresh</button>
        <a href="/api/export/harvest?start_date={{ week_start }}&end_date={{ week_end }}" class="btn btn-primary">Export CSV</a>
    </div>
</div>

<div class="filter-bar">
    <input type="text" id="filter-input" placeholder="Filter events..." onkeyup="filterEvents()">
    <label class="filter-checkbox">
        <input type="checkbox" id="show-dna-checkbox" onchange="filterEvents()">
        <span>Show meetings I did not attend</span>
    </label>
</div>

<div class="week-container">
<div class="week-grid">
    {% for day in days %}
    <div class="day-column {% if day.is_today %}today{% endif %}">
        <div class="day-header">
            <span class="day-name">{{ day.day_name }}</span>
            <span class="day-number">{{ day.day_number }}</span>
        </div>
        <div class="day-events">
            {% for event in day.events %}
            <div class="event-card {% if event.is_classified %}classified{% else %}unclassified{% endif %} {% if event.did_not_attend %}did-not-attend{% endif %}"
                 data-event-id="{{ event.id }}"
                 data-title="{{ event.title }}"
                 data-description="{{ event.description or '' }}"
                 data-attendees="{{ event.attendees | join(', ') if event.attendees else '' }}"
                 data-project="{{ event.project_name or '' }}"
                 data-did-not-attend="{{ 'true' if event.did_not_attend else 'false' }}"
                 data-google-event-id="{{ event.google_event_id or '' }}"
                 data-duration="{{ event.duration }}">

                <!-- Event side (unclassified view) -->
                <div class="card-side card-event {% if event.is_classified %}hidden{% endif %}"
                     data-project-color="{{ event.project_color or '' }}">
                    <!-- Row 1: Title with tooltip + calendar link -->
                    <div class="card-row-title">
                        <span class="title-text title-tooltip">
                            {{ event.title }}
                            <div class="tooltip-content">
                                <strong>{{ event.title }}</strong>
                                {% if event.my_response_status %}
                                <div class="tooltip-row"><span class="tooltip-label">My status:</span> {{ event.my_response_status }}</div>
                                {% endif %}
                                {% if event.attendees %}
                                <div class="tooltip-row"><span class="tooltip-label">Attendees:</span> {{ event.attendees | join(', ') }}</div>
                                {% endif %}
                                {% if event.description %}
                                <div class="tooltip-row"><span class="tooltip-label">Description:</span> {{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</div>
                                {% endif %}
                            </div>
                        </span>
                        {% if event.google_event_id %}
                        <a href="https://calendar.google.com/calendar/event?eid={{ event.google_event_id }}" class="btn-calendar-link" title="Open in Google Calendar" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                    <!-- Row 2: Project dropdown -->
                    <div class="card-row-project">
                        <select onchange="classifyEvent({{ event.id }}, this.value, this.options[this.selectedIndex].dataset.color)" {% if event.did_not_attend %}disabled{% endif %}>
                            <option value="">Select project...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Row 3: Time -->
                    <div class="card-row-time">
                        <span>{{ event.start_time[11:16] }} - {{ event.end_time[11:16] }}</span>
                        {% if event.my_response_status and event.my_response_status != 'accepted' %}
                        <span class="response-status" title="Response: {{ event.my_response_status }}">
                            {% if event.my_response_status == 'declined' %}✗{% elif event.my_response_status == 'tentative' %}?{% elif event.my_response_status == 'needsAction' %}•{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    <!-- Row 4: Actions -->
                    <div class="card-row-actions">
                        <label class="checkbox-dna">
                            <input type="checkbox" {% if event.did_not_attend %}checked{% endif %} onchange="toggleDidNotAttend({{ event.id }})"> DNA
                        </label>
                        <button class="btn-icon" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">&#9881;</button>
                    </div>
                    {% if event.is_classified %}
                    <div class="dog-ear" onclick="flipCard({{ event.id }})" title="Flip to time entry">
                        <svg class="flip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M17 1l4 4-4 4"></path>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                            <path d="M7 23l-4-4 4-4"></path>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                        </svg>
                    </div>
                    {% endif %}
                </div>

                <!-- Time entry side (classified view) -->
                <div class="card-side card-entry {% if not event.is_classified %}hidden{% endif %}"
                     data-entry-id="{{ event.entry_id }}"
                     style="background-color: {{ event.project_color }}">
                    <!-- Row 1: Title with tooltip + calendar link -->
                    <div class="card-row-title">
                        <span class="title-text title-tooltip">
                            {{ event.title }}
                            <div class="tooltip-content">
                                <strong>{{ event.title }}</strong>
                                {% if event.my_response_status %}
                                <div class="tooltip-row"><span class="tooltip-label">My status:</span> {{ event.my_response_status }}</div>
                                {% endif %}
                                {% if event.attendees %}
                                <div class="tooltip-row"><span class="tooltip-label">Attendees:</span> {{ event.attendees | join(', ') }}</div>
                                {% endif %}
                                {% if event.description %}
                                <div class="tooltip-row"><span class="tooltip-label">Description:</span> {{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</div>
                                {% endif %}
                            </div>
                        </span>
                        {% if event.google_event_id %}
                        <a href="https://calendar.google.com/calendar/event?eid={{ event.google_event_id }}" class="btn-calendar-link" title="Open in Google Calendar" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                    <!-- Row 2: Project dropdown -->
                    <div class="card-row-project">
                        <select onchange="reclassifyEvent({{ event.id }}, {{ event.entry_id }}, this.value, this.options[this.selectedIndex].dataset.color)">
                            <option value="">— Unclassify —</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}" {% if project.id == event.project_id %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Row 3: Duration with +15m -->
                    <div class="card-row-time">
                        <input type="text" class="duration-input" value="{{ '%.2f'|format(event.hours or 0) }}" data-entry-id="{{ event.entry_id }}" onchange="updateHours({{ event.entry_id }}, this.value)">
                        <span>hrs</span>
                        <button class="btn-round" onclick="roundUp({{ event.id }}, {{ event.entry_id }})">+15m</button>
                        {% if event.invoice_id %}
                        <a href="/invoices" class="badge badge-billed" title="Billed: {{ event.invoice_number }}">$</a>
                        {% endif %}
                    </div>
                    <!-- Row 4: Actions -->
                    <div class="card-row-actions">
                        <label class="checkbox-dna">
                            <input type="checkbox" {% if event.did_not_attend %}checked{% endif %} onchange="toggleDidNotAttend({{ event.id }})"> DNA
                        </label>
                        <button class="btn-icon" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">&#9881;</button>
                    </div>
                    <div class="dog-ear" onclick="flipCard({{ event.id }})" title="Flip to event">
                        <svg class="flip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M17 1l4 4-4 4"></path>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                            <path d="M7 23l-4-4 4-4"></path>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                        </svg>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-events">No events</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<aside class="project-summary-sidebar">
    <h3>Project Summary</h3>
    <div class="summary-total">{{ "%.1f"|format(total_hours) }} hrs total</div>

    <!-- Active Projects (always shown, even with 0 hours) -->
    <div class="summary-section active-section">
        <div class="summary-list">
            {% for proj in regular_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}" data-project-name="{{ proj.name }}">
                <div class="summary-row">
                    <label class="summary-toggle" title="Temporarily hide events for this project">
                        <input type="checkbox" checked
                               onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                        <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                        <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                    </label>
                    <a href="/projects#{{ proj.name | urlencode }}" class="summary-link" title="Go to project settings">
                        <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    </a>
                    <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
                </div>
                {% if total_hours > 0 and not proj.does_not_accumulate_hours %}
                <div class="summary-bar">
                    <div class="summary-bar-fill" style="width: {{ (proj.hours / total_hours * 100)|int }}%; background-color: {{ proj.color }}"></div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Unclassified Events -->
    <div class="summary-section unclassified-section" id="unclassified-section">
        <div class="summary-section-header">
            Unclassified
            <span class="section-total" id="unclassified-total">0.0 hrs</span>
        </div>
    </div>

    <!-- Archived Projects (collapsible, open by default, only if hours > 0) -->
    {% if archived_projects %}
    <div class="summary-section archived-section" id="archived-section">
        <div class="summary-section-header collapsible" onclick="toggleSection('archived')">
            <span class="collapse-icon" id="archived-collapse-icon">▼</span>
            <label class="section-bulk-toggle" onclick="event.stopPropagation()">
                <input type="checkbox" id="archived-bulk-checkbox"
                       onchange="toggleSectionProjects('archived', this.checked)">
            </label>
            Archived ({{ archived_projects|length }})
            <span class="section-total">{{ "%.1f"|format(archived_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list" id="archived-projects-list">
            {% for proj in archived_projects %}
            <div class="summary-item archived" data-project-id="{{ proj.id }}" data-project-name="{{ proj.name }}" data-section="archived">
                <div class="summary-row">
                    <label class="summary-toggle" title="Temporarily hide events for this project">
                        <input type="checkbox"
                               onchange="toggleProjectVisibility({{ proj.id }}, this.checked); updateSectionCheckbox('archived')">
                        <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                        <span class="summary-name">{{ proj.name }}</span>
                    </label>
                    <a href="/projects#{{ proj.name | urlencode }}" class="summary-link" title="Go to project settings">
                        <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    </a>
                    <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        <p class="archived-hint">These entries need reclassification.</p>
    </div>
    {% endif %}

    <!-- Hidden Projects (collapsible, closed by default, only if hours > 0) -->
    {% if hidden_projects %}
    <div class="summary-section hidden-section" id="hidden-section">
        <div class="summary-section-header collapsible" onclick="toggleSection('hidden')">
            <span class="collapse-icon" id="hidden-collapse-icon">▶</span>
            <label class="section-bulk-toggle" onclick="event.stopPropagation()">
                <input type="checkbox" id="hidden-bulk-checkbox"
                       onchange="toggleSectionProjects('hidden', this.checked)">
            </label>
            Hidden ({{ hidden_projects|length }})
            <span class="section-total">{{ "%.1f"|format(hidden_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list hidden" id="hidden-projects-list">
            {% for proj in hidden_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}" data-project-name="{{ proj.name }}" data-section="hidden">
                <div class="summary-row">
                    <label class="summary-toggle" title="Temporarily hide events for this project">
                        <input type="checkbox"
                               onchange="toggleProjectVisibility({{ proj.id }}, this.checked); updateSectionCheckbox('hidden')">
                        <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                        <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                    </label>
                    <a href="/projects#{{ proj.name | urlencode }}" class="summary-link" title="Go to project settings">
                        <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    </a>
                    <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</aside>
</div>
<!-- Create Rule Modal (v2 Query-based) -->
<div id="rule-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 650px;">
        <h2>Create Rule from Event</h2>
        <div id="rule-modal-loading">Loading event data...</div>
        <div id="rule-modal-form" class="hidden">
            <div class="form-row">
                <label for="modal-target-type">Assign to:</label>
                <select id="modal-target-type" onchange="toggleModalProjectSelect()">
                    <optgroup label="Projects">
                        {% for project in projects %}
                        <option value="project:{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Special">
                        <option value="dna">Mark as Did Not Attend</option>
                    </optgroup>
                </select>
            </div>

            <div class="event-properties-section">
                <h3>Match by</h3>
                <p class="form-hint">Click patterns to include/exclude them from the query.</p>
                <div id="modal-patterns-list" class="tag-list" style="margin-bottom: 0.75rem;"></div>
            </div>

            <div class="form-row" style="flex-direction: column; align-items: stretch;">
                <label for="modal-query">Query:</label>
                <input type="text" id="modal-query" style="width: 100%; font-family: monospace;" placeholder="domain:example.com title:meeting">
            </div>

            <div id="modal-preview-section" class="preview-section" style="margin: 1rem 0;">
                <div class="preview-header">
                    <span id="modal-preview-count">0 events match</span>
                </div>
                <div id="modal-preview-list" class="preview-list"></div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveRuleFromModal()">Create Rule</button>
                <button class="btn btn-secondary" onclick="hideRuleModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Help Modal -->
<div id="shortcuts-modal" class="modal-overlay hidden">
    <div class="modal-content modal-small">
        <h2>Keyboard Shortcuts</h2>
        <table class="shortcuts-table">
            <tr><td><kbd>j</kbd></td><td>Next week</td></tr>
            <tr><td><kbd>k</kbd></td><td>Previous week</td></tr>
            <tr><td><kbd>t</kbd></td><td>Today</td></tr>
            <tr><td><kbd>?</kbd></td><td>Show this help</td></tr>
        </table>
        <div class="form-actions">
            <button class="btn btn-secondary" onclick="hideShortcutsModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js?v=10"></script>
<script>
    // Initialize with current week dates
    window.weekStart = "{{ week_start }}";
    window.weekEnd = "{{ week_end }}";

    // Navigation URLs
    window.nextWeekUrl = "/week/{{ next_week }}";
    window.prevWeekUrl = "/week/{{ prev_week }}";
    window.todayUrl = "/";

    // Auto-sync, auto-classify, and restore visibility preferences on page load
    document.addEventListener('DOMContentLoaded', async function() {
        applyInitialTextColors();
        syncEventsQuiet();
        await autoClassifyEvents();
        restoreProjectVisibility();
        filterEvents();  // Apply initial filters (hides DNA events by default)
        updateProjectSummary();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ignore if typing in an input field
        if (e.target.matches('input, textarea, select')) return;
        // Ignore if a modal is open (except shortcuts modal for Escape)
        const ruleModal = document.getElementById('rule-modal');
        const shortcutsModal = document.getElementById('shortcuts-modal');

        if (!shortcutsModal.classList.contains('hidden')) {
            if (e.key === 'Escape' || e.key === '?') {
                hideShortcutsModal();
            }
            return;
        }

        if (!ruleModal.classList.contains('hidden')) return;

        switch (e.key) {
            case 'j':
                window.location.href = window.nextWeekUrl;
                break;
            case 'k':
                window.location.href = window.prevWeekUrl;
                break;
            case 't':
                window.location.href = window.todayUrl;
                break;
            case '?':
                showShortcutsModal();
                break;
        }
    });

    function showShortcutsModal() {
        document.getElementById('shortcuts-modal').classList.remove('hidden');
    }

    function hideShortcutsModal() {
        document.getElementById('shortcuts-modal').classList.add('hidden');
    }

    /**
     * Apply appropriate text color classes to all entry cards based on their background color.
     */
    function applyInitialTextColors() {
        document.querySelectorAll('.card-entry').forEach(entry => {
            const bgColor = entry.style.backgroundColor;
            if (bgColor) {
                // Convert rgb(r, g, b) to hex if needed
                let hexColor = bgColor;
                if (bgColor.startsWith('rgb')) {
                    const rgb = bgColor.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        hexColor = '#' + rgb.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                    }
                }
                applyTextColorClass(entry, hexColor);
            }
        });
    }

    /**
     * Auto-classify unclassified events using rules.
     * Reloads page if any events were classified.
     */
    async function autoClassifyEvents() {
        // Prevent reload loops
        if (sessionStorage.getItem('justClassified') === window.location.pathname) {
            sessionStorage.removeItem('justClassified');
            return;
        }

        try {
            const result = await api.applyRules(window.weekStart, window.weekEnd);
            if (result.classified > 0) {
                sessionStorage.setItem('justClassified', window.location.pathname);
                location.reload();
            }
        } catch (error) {
            console.error('Auto-classify failed:', error.message);
        }
    }

    /**
     * Restore project visibility preferences from sessionStorage.
     */
    function restoreProjectVisibility() {
        console.log('restoreProjectVisibility called');
        const visibilityKey = `projectVisibility_${window.weekStart}`;
        const visibility = JSON.parse(sessionStorage.getItem(visibilityKey) || '{}');
        console.log('  sessionStorage visibility:', visibility);

        // Restore checkbox states from sessionStorage
        for (const [projectId, isVisible] of Object.entries(visibility)) {
            const checkbox = document.querySelector(`.summary-item[data-project-id="${projectId}"] input[type="checkbox"]`);
            if (checkbox) {
                console.log('  restoring checkbox for project', projectId, 'to', isVisible);
                checkbox.checked = isVisible;
            }
        }

        // Hide events for all unchecked checkboxes
        initProjectVisibility();

        // Update section bulk checkboxes after restoring individual states
        updateSectionCheckbox('archived');
        updateSectionCheckbox('hidden');
    }

    // Rule creation from event (v2 query-based)
    let currentEventId = null;
    let selectedPatterns = new Set();
    let availablePatterns = [];
    let modalPreviewTimeout = null;

    /**
     * Toggle project select visibility (not needed for v2, but keeping stub).
     */
    function toggleModalProjectSelect() {}

    /**
     * Show the create rule modal for an event.
     */
    async function showCreateRuleModal(eventId) {
        currentEventId = eventId;
        selectedPatterns = new Set();
        const modal = document.getElementById('rule-modal');
        const loading = document.getElementById('rule-modal-loading');
        const form = document.getElementById('rule-modal-form');

        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        form.classList.add('hidden');

        try {
            // Fetch event properties
            const eventProps = await api.get(`/api/events/${eventId}/properties`);

            // Generate suggested patterns from event
            availablePatterns = [];

            // Extract domains from attendees
            if (eventProps.attendees && eventProps.attendees.length > 0) {
                const domains = new Set();
                for (const attendee of eventProps.attendees) {
                    const match = attendee.match(/@([^@]+)$/);
                    if (match) domains.add(match[1].toLowerCase());
                }
                for (const domain of domains) {
                    availablePatterns.push({
                        type: 'domain',
                        value: domain,
                        query: `domain:${domain}`,
                        display: `domain:${domain}`
                    });
                }
            }

            // Add title pattern if meaningful
            if (eventProps.title && eventProps.title.length > 3) {
                const title = eventProps.title.trim();
                // Add exact title match
                availablePatterns.push({
                    type: 'title',
                    value: title,
                    query: title.includes(' ') ? `title:"${title}"` : `title:${title}`,
                    display: `title:"${title.substring(0, 30)}${title.length > 30 ? '...' : ''}"`
                });

                // Add first word if multi-word title
                const words = title.split(/\s+/);
                if (words.length > 1 && words[0].length >= 3) {
                    availablePatterns.push({
                        type: 'title',
                        value: words[0],
                        query: `title:${words[0].toLowerCase()}`,
                        display: `title:${words[0].toLowerCase()}`
                    });
                }
            }

            // Add response status if not accepted
            if (eventProps.my_response_status && eventProps.my_response_status !== 'accepted') {
                availablePatterns.push({
                    type: 'response',
                    value: eventProps.my_response_status,
                    query: `response:${eventProps.my_response_status}`,
                    display: `response:${eventProps.my_response_status}`
                });
            }

            // Add recurring pattern
            if (eventProps.is_recurring) {
                availablePatterns.push({
                    type: 'recurring',
                    value: 'yes',
                    query: 'recurring:yes',
                    display: 'recurring:yes'
                });
            }

            // Render pattern chips
            renderPatternChips();

            // Setup query input change handler
            const queryInput = document.getElementById('modal-query');
            queryInput.value = '';
            queryInput.addEventListener('input', debounceModalPreview);

            loading.classList.add('hidden');
            form.classList.remove('hidden');

        } catch (error) {
            alert('Error loading event: ' + error.message);
            hideRuleModal();
        }
    }

    /**
     * Render clickable pattern chips.
     */
    function renderPatternChips() {
        const container = document.getElementById('modal-patterns-list');
        container.innerHTML = '';

        for (const pattern of availablePatterns) {
            const chip = document.createElement('span');
            chip.className = 'tag pattern-chip';
            if (selectedPatterns.has(pattern.query)) {
                chip.classList.add('selected');
            }
            chip.textContent = pattern.display;
            chip.dataset.query = pattern.query;
            chip.onclick = () => togglePattern(pattern.query);
            container.appendChild(chip);
        }
    }

    /**
     * Toggle a pattern selection.
     */
    function togglePattern(query) {
        if (selectedPatterns.has(query)) {
            selectedPatterns.delete(query);
        } else {
            selectedPatterns.add(query);
        }
        renderPatternChips();
        updateQueryFromPatterns();
        doModalPreview();
    }

    /**
     * Update the query input from selected patterns.
     */
    function updateQueryFromPatterns() {
        const patterns = Array.from(selectedPatterns);
        let query = '';
        if (patterns.length === 1) {
            query = patterns[0];
        } else if (patterns.length > 1) {
            query = '(' + patterns.join(' OR ') + ')';
        }
        document.getElementById('modal-query').value = query;
    }

    /**
     * Debounce modal preview.
     */
    function debounceModalPreview() {
        clearTimeout(modalPreviewTimeout);
        modalPreviewTimeout = setTimeout(doModalPreview, 300);
    }

    /**
     * Fetch and display preview results.
     */
    async function doModalPreview() {
        const query = document.getElementById('modal-query').value.trim();
        const previewCount = document.getElementById('modal-preview-count');
        const previewList = document.getElementById('modal-preview-list');

        if (!query) {
            previewCount.textContent = '0 events match';
            previewList.innerHTML = '<p class="no-matches">Enter a query to see matching events</p>';
            return;
        }

        try {
            const result = await api.post('/api/rules/preview', { query, limit: 10 });
            previewCount.textContent = `${result.total} event(s) match`;

            if (result.events.length === 0) {
                previewList.innerHTML = '<p class="no-matches">No matching events</p>';
            } else {
                previewList.innerHTML = result.events.map(e => `
                    <div class="preview-item">
                        <span class="preview-date">${e.start_time ? e.start_time.slice(0, 10) : ''}</span>
                        <span class="preview-title">${escapeHtml(e.title || 'Untitled')}</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            previewCount.textContent = 'Error';
            previewList.innerHTML = `<p class="error-message">${escapeHtml(error.message)}</p>`;
        }
    }

    /**
     * Hide the rule creation modal.
     */
    function hideRuleModal() {
        document.getElementById('rule-modal').classList.add('hidden');
        currentEventId = null;
        selectedPatterns = new Set();
    }

    /**
     * Save the rule from the modal form.
     */
    async function saveRuleFromModal() {
        const query = document.getElementById('modal-query').value.trim();
        const targetValue = document.getElementById('modal-target-type').value;

        if (!query) {
            showToast('Query is required', 'error');
            return;
        }

        const ruleData = { query };

        if (targetValue === 'dna') {
            ruleData.target_type = 'did_not_attend';
        } else if (targetValue.startsWith('project:')) {
            ruleData.target_type = 'project';
            ruleData.project_id = parseInt(targetValue.split(':')[1]);
        }

        try {
            await api.post('/api/rules', ruleData);
            showToast('Rule created!', 'success');
            hideRuleModal();
        } catch (error) {
            showToast('Error creating rule: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML for safe display.
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('rule-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideRuleModal();
        }
    });

    /**
     * Toggle a collapsible section in sidebar.
     */
    function toggleSection(sectionName) {
        const list = document.getElementById(`${sectionName}-projects-list`);
        const icon = document.getElementById(`${sectionName}-collapse-icon`);
        if (list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            icon.textContent = '▼';
        } else {
            list.classList.add('hidden');
            icon.textContent = '▶';
        }
    }

    /**
     * Toggle all projects in a section (bulk checkbox).
     */
    function toggleSectionProjects(sectionName, checked) {
        const items = document.querySelectorAll(`.summary-item[data-section="${sectionName}"]`);
        items.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked !== checked) {
                checkbox.checked = checked;
                const projectId = parseInt(item.dataset.projectId);
                toggleProjectVisibility(projectId, checked);
            }
        });
    }

    /**
     * Update section bulk checkbox state based on individual checkboxes.
     */
    function updateSectionCheckbox(sectionName) {
        const items = document.querySelectorAll(`.summary-item[data-section="${sectionName}"]`);
        const bulkCheckbox = document.getElementById(`${sectionName}-bulk-checkbox`);
        if (!bulkCheckbox || items.length === 0) return;

        let checkedCount = 0;
        items.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) checkedCount++;
        });

        if (checkedCount === 0) {
            bulkCheckbox.checked = false;
            bulkCheckbox.indeterminate = false;
        } else if (checkedCount === items.length) {
            bulkCheckbox.checked = true;
            bulkCheckbox.indeterminate = false;
        } else {
            bulkCheckbox.checked = false;
            bulkCheckbox.indeterminate = true;
        }
    }

    /**
     * Initialize section checkboxes on page load.
     */
    function initSectionCheckboxes() {
        updateSectionCheckbox('archived');
        updateSectionCheckbox('hidden');
    }

    /**
     * Toggle the did_not_attend flag for an event.
     */
    async function toggleDidNotAttend(eventId) {
        const card = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const currentValue = card.dataset.didNotAttend === 'true';
        const newValue = !currentValue;

        try {
            await api.put(`/api/events/${eventId}/attendance`, { did_not_attend: newValue });

            // Update the UI
            card.dataset.didNotAttend = newValue ? 'true' : 'false';
            if (newValue) {
                card.classList.add('did-not-attend');
            } else {
                card.classList.remove('did-not-attend');
            }

            // Update all DNA checkboxes on this card (both event side and entry side)
            const checkboxes = card.querySelectorAll('.checkbox-dna input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = newValue);

            // Disable/enable the project selects
            const selects = card.querySelectorAll('.card-row-project select');
            selects.forEach(select => {
                // Only disable on event side, entry side can still reclassify
                if (select.closest('.card-event')) {
                    select.disabled = newValue;
                }
            });

            // Update sidebar totals (DNA events don't contribute to hours)
            updateProjectSummary();

            showToast(newValue ? 'Marked as did not attend' : 'Marked as attended', 'success');

        } catch (error) {
            showToast('Error updating attendance: ' + error.message, 'error');
            // Revert checkbox state on error
            const checkboxes = card.querySelectorAll('.checkbox-dna input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = currentValue);
        }
    }
</script>
{% endblock %}
