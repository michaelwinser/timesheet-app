{% extends "base.html" %}

{% block title %}Week of {{ week_start.strftime('%b %d') }} - Timesheet{% endblock %}

{% block content %}
<div class="week-header">
    <div class="week-nav">
        <a href="/week/{{ prev_week }}" class="btn btn-secondary">&larr; Prev</a>
        <a href="/" class="btn btn-secondary">Today</a>
        <a href="/week/{{ next_week }}" class="btn btn-secondary">Next &rarr;</a>
    </div>
    <h1 class="week-title">Week of {{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}</h1>
    <div class="week-actions">
        <button id="sync-btn" class="btn btn-secondary" onclick="refreshEvents()">↻ Refresh</button>
        <a href="/api/export/harvest?start_date={{ week_start }}&end_date={{ week_end }}" class="btn btn-primary">Export CSV</a>
    </div>
</div>

<div class="filter-bar">
    <input type="text" id="filter-input" placeholder="Filter events..." onkeyup="filterEvents()">
</div>

<div class="week-container">
<div class="week-grid">
    {% for day in days %}
    <div class="day-column {% if day.is_today %}today{% endif %}">
        <div class="day-header">
            <span class="day-name">{{ day.day_name }}</span>
            <span class="day-number">{{ day.day_number }}</span>
        </div>
        <div class="day-events">
            {% for event in day.events %}
            <div class="event-card {% if event.is_classified %}classified{% else %}unclassified{% endif %} {% if event.did_not_attend %}did-not-attend{% endif %}"
                 data-event-id="{{ event.id }}"
                 data-title="{{ event.title }}"
                 data-project="{{ event.project_name or '' }}"
                 data-did-not-attend="{{ 'true' if event.did_not_attend else 'false' }}">

                <!-- Did Not Attend Badge -->
                {% if event.did_not_attend %}
                <div class="did-not-attend-badge" title="Did not attend">✗</div>
                {% endif %}

                <!-- Event side (unclassified view) -->
                <div class="card-side card-event {% if event.is_classified %}hidden{% endif %}"
                     data-project-color="{{ event.project_color or '' }}">
                    {% if event.is_classified %}
                    <div class="project-badge" style="background-color: {{ event.project_color }}"></div>
                    {% endif %}
                    <div class="event-title">{{ event.title }}</div>
                    <div class="event-time">
                        {{ event.start_time[11:16] }} - {{ event.end_time[11:16] }}
                        {% if event.my_response_status and event.my_response_status != 'accepted' %}
                        <span class="response-status" title="Response: {{ event.my_response_status }}">
                            {% if event.my_response_status == 'declined' %}✗{% elif event.my_response_status == 'tentative' %}?{% elif event.my_response_status == 'needsAction' %}•{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    {% if event.attendees %}
                    <div class="event-attendees">
                        {{ event.attendees | length }} attendee(s)
                    </div>
                    {% endif %}
                    {% if event.meeting_link %}
                    <a href="{{ event.meeting_link }}" target="_blank" class="event-link">Join</a>
                    {% endif %}
                    <div class="event-actions">
                        <select class="project-select" onchange="classifyEvent({{ event.id }}, this.value, this.options[this.selectedIndex].dataset.color)" {% if event.did_not_attend %}disabled{% endif %}>
                            <option value="">Classify...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn-small btn-attendance {% if event.did_not_attend %}active{% endif %}"
                                onclick="toggleDidNotAttend({{ event.id }})"
                                title="{% if event.did_not_attend %}Mark as attended{% else %}Mark as did not attend{% endif %}">
                            {% if event.did_not_attend %}✓{% else %}✗{% endif %}
                        </button>
                        <button class="btn-small btn-rule" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">⚙</button>
                        {% if event.is_classified %}
                        <button class="btn-small" onclick="flipCard({{ event.id }})">Flip</button>
                        {% endif %}
                    </div>
                </div>

                <!-- Time entry side (classified view) -->
                <div class="card-side card-entry {% if not event.is_classified %}hidden{% endif %}"
                     data-entry-id="{{ event.entry_id }}"
                     style="background-color: {{ event.project_color }}">
                    <div class="entry-header">
                        <select class="project-select entry-project-select" onchange="reclassifyEvent({{ event.id }}, {{ event.entry_id }}, this.value, this.options[this.selectedIndex].dataset.color)">
                            <option value="">— Unclassify —</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}" {% if project.id == event.project_id %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="entry-hours">
                        <span class="hours-value">{{ "%.2f"|format(event.hours or 0) }}</span> hrs
                        <button class="btn-small" onclick="roundUp({{ event.id }}, {{ event.entry_id }})">+15m</button>
                    </div>
                    <div class="entry-description">{{ event.entry_description or event.title }}</div>
                    <div class="entry-actions">
                        <button class="btn-small btn-rule" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">⚙</button>
                        <button class="btn-small" onclick="flipCard({{ event.id }})">Flip</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-events">No events</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<aside class="project-summary-sidebar">
    <h3>Project Summary</h3>
    <div class="summary-total">{{ "%.1f"|format(total_hours) }} hrs total</div>

    <!-- Regular Projects -->
    <div class="summary-section">
        <div class="summary-section-header">Projects</div>
        <div class="summary-list">
            {% for proj in regular_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox" checked
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
                {% if total_hours > 0 and not proj.does_not_accumulate_hours %}
                <div class="summary-bar">
                    <div class="summary-bar-fill" style="width: {{ (proj.hours / total_hours * 100)|int }}%; background-color: {{ proj.color }}"></div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Hidden Projects (collapsed by default) -->
    {% if hidden_projects %}
    <div class="summary-section hidden-section" id="hidden-section">
        <div class="summary-section-header collapsible" onclick="toggleHiddenSection()">
            <span class="collapse-icon">▶</span>
            Hidden ({{ hidden_projects|length }})
            <span class="section-total">{{ "%.1f"|format(hidden_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list hidden" id="hidden-projects-list">
            {% for proj in hidden_projects %}
            <div class="summary-item" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox"
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}{% if proj.does_not_accumulate_hours %} <span class="badge-tiny">no hrs</span>{% endif %}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Archived Projects (only shown if they have entries in current view) -->
    {% if archived_projects %}
    <div class="summary-section archived-section">
        <div class="summary-section-header warning">
            <span class="warning-icon">⚠</span>
            Archived ({{ archived_projects|length }})
            <span class="section-total">{{ "%.1f"|format(archived_projects|sum(attribute='hours')) }} hrs</span>
        </div>
        <div class="summary-list">
            {% for proj in archived_projects %}
            <div class="summary-item archived" data-project-id="{{ proj.id }}">
                <label class="summary-toggle">
                    <input type="checkbox"
                           onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                    <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                    <span class="summary-name">{{ proj.name }}</span>
                </label>
                <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
            </div>
            {% endfor %}
        </div>
        <p class="archived-hint">These entries need reclassification.</p>
    </div>
    {% endif %}
</aside>
</div>
<!-- Create Rule Modal -->
<div id="rule-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Create Rule from Event</h2>
        <div id="rule-modal-loading">Loading event properties...</div>
        <div id="rule-modal-form" class="hidden">
            <div class="form-row">
                <label for="modal-rule-name">Rule Name:</label>
                <input type="text" id="modal-rule-name" placeholder="e.g., Client meetings">
            </div>

            <div class="form-row">
                <label for="modal-rule-project">Project:</label>
                <select id="modal-rule-project">
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label for="modal-rule-priority">Priority:</label>
                <input type="number" id="modal-rule-priority" value="50" min="0" max="100">
                <span class="form-hint">Higher = evaluated first</span>
            </div>

            <div class="event-properties-section">
                <h3>Event Properties</h3>
                <p class="form-hint">Select properties to use as conditions for this rule. The current values from this event will be pre-filled.</p>
                <div id="modal-properties-list"></div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveRuleFromModal()">Create Rule</button>
                <button class="btn btn-secondary" onclick="hideRuleModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
<script>
    // Initialize with current week dates
    window.weekStart = "{{ week_start }}";
    window.weekEnd = "{{ week_end }}";

    // Auto-sync, auto-classify, and restore visibility preferences on page load
    document.addEventListener('DOMContentLoaded', async function() {
        syncEventsQuiet();
        await autoClassifyEvents();
        restoreProjectVisibility();
    });

    /**
     * Auto-classify unclassified events using rules.
     * Reloads page if any events were classified.
     */
    async function autoClassifyEvents() {
        // Prevent reload loops
        if (sessionStorage.getItem('justClassified') === window.location.pathname) {
            sessionStorage.removeItem('justClassified');
            return;
        }

        try {
            const result = await api.applyRules(window.weekStart, window.weekEnd);
            if (result.classified > 0) {
                sessionStorage.setItem('justClassified', window.location.pathname);
                location.reload();
            }
        } catch (error) {
            console.error('Auto-classify failed:', error.message);
        }
    }

    /**
     * Restore project visibility preferences from sessionStorage.
     */
    function restoreProjectVisibility() {
        const visibilityKey = `projectVisibility_${window.weekStart}`;
        const visibility = JSON.parse(sessionStorage.getItem(visibilityKey) || '{}');

        for (const [projectId, isVisible] of Object.entries(visibility)) {
            if (!isVisible) {
                // Update checkbox state
                const checkbox = document.querySelector(`.summary-item[data-project-id="${projectId}"] input[type="checkbox"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    // Trigger visibility update
                    toggleProjectVisibility(parseInt(projectId), false);
                }
            }
        }
    }

    // Rule creation from event
    let currentEventId = null;
    let propertyDefinitions = [];
    let conditionTypes = [];

    /**
     * Show the create rule modal for an event.
     */
    async function showCreateRuleModal(eventId) {
        currentEventId = eventId;
        const modal = document.getElementById('rule-modal');
        const loading = document.getElementById('rule-modal-loading');
        const form = document.getElementById('rule-modal-form');

        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        form.classList.add('hidden');

        try {
            // Fetch property definitions, condition types, and event properties in parallel
            const [propDefs, condTypes, eventProps] = await Promise.all([
                api.get('/api/properties'),
                api.get('/api/conditions'),
                api.get(`/api/events/${eventId}/properties`)
            ]);

            propertyDefinitions = propDefs;
            conditionTypes = condTypes;

            // Pre-fill rule name with event title
            const eventTitle = eventProps.title || 'Untitled';
            document.getElementById('modal-rule-name').value = `${eventTitle} Rule`;

            // Build the properties list with checkboxes
            const listContainer = document.getElementById('modal-properties-list');
            listContainer.innerHTML = '';

            for (const prop of propertyDefinitions) {
                const currentValue = eventProps[prop.name];
                // Skip properties with no value
                if (currentValue === null || currentValue === undefined || currentValue === '' ||
                    (Array.isArray(currentValue) && currentValue.length === 0)) {
                    continue;
                }

                const row = document.createElement('div');
                row.className = 'property-row';

                // Get applicable condition types for this property
                const applicableConditions = conditionTypes.filter(c =>
                    c.applies_to.includes(prop.value_type)
                );

                // Format the current value for display
                let displayValue = currentValue;
                if (Array.isArray(currentValue)) {
                    displayValue = currentValue.join(', ');
                }

                row.innerHTML = `
                    <label class="property-checkbox">
                        <input type="checkbox" class="prop-check" data-property="${prop.name}" data-type="${prop.value_type}">
                        <span class="prop-name">${prop.display_name}</span>
                    </label>
                    <select class="prop-condition" disabled>
                        ${applicableConditions.map(c => `<option value="${c.type}">${c.display}</option>`).join('')}
                    </select>
                    <input type="text" class="prop-value" value="${escapeHtml(String(displayValue))}" disabled>
                `;

                // Enable/disable condition and value when checkbox is toggled
                const checkbox = row.querySelector('.prop-check');
                const condSelect = row.querySelector('.prop-condition');
                const valueInput = row.querySelector('.prop-value');

                checkbox.addEventListener('change', () => {
                    condSelect.disabled = !checkbox.checked;
                    valueInput.disabled = !checkbox.checked;
                });

                listContainer.appendChild(row);
            }

            loading.classList.add('hidden');
            form.classList.remove('hidden');

        } catch (error) {
            alert('Error loading event properties: ' + error.message);
            hideRuleModal();
        }
    }

    /**
     * Hide the rule creation modal.
     */
    function hideRuleModal() {
        document.getElementById('rule-modal').classList.add('hidden');
        currentEventId = null;
    }

    /**
     * Save the rule from the modal form.
     */
    async function saveRuleFromModal() {
        const name = document.getElementById('modal-rule-name').value.trim();
        const projectId = parseInt(document.getElementById('modal-rule-project').value);
        const priority = parseInt(document.getElementById('modal-rule-priority').value);

        if (!name) {
            alert('Rule name is required');
            return;
        }

        // Gather selected conditions
        const conditions = [];
        const rows = document.querySelectorAll('.property-row');
        for (const row of rows) {
            const checkbox = row.querySelector('.prop-check');
            if (!checkbox.checked) continue;

            const propertyName = checkbox.dataset.property;
            const conditionType = row.querySelector('.prop-condition').value;
            let conditionValue = row.querySelector('.prop-value').value;

            // Convert comma-separated values to array for list types
            const propType = checkbox.dataset.type;
            if (propType === 'list' || conditionType === 'in_list') {
                conditionValue = conditionValue.split(',').map(v => v.trim()).filter(v => v);
            }

            conditions.push({
                property_name: propertyName,
                condition_type: conditionType,
                condition_value: conditionValue
            });
        }

        if (conditions.length === 0) {
            alert('At least one condition is required. Please select a property.');
            return;
        }

        try {
            await api.post('/api/rules', {
                name,
                project_id: projectId,
                priority,
                is_enabled: true,
                conditions
            });

            showToast('Rule created successfully!', 'success');
            hideRuleModal();

        } catch (error) {
            showToast('Error creating rule: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML for safe display.
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('rule-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideRuleModal();
        }
    });

    /**
     * Toggle the hidden projects section in sidebar.
     */
    function toggleHiddenSection() {
        const list = document.getElementById('hidden-projects-list');
        const icon = document.querySelector('#hidden-section .collapse-icon');
        if (list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            icon.textContent = '▼';
        } else {
            list.classList.add('hidden');
            icon.textContent = '▶';
        }
    }

    /**
     * Toggle the did_not_attend flag for an event.
     */
    async function toggleDidNotAttend(eventId) {
        const card = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const currentValue = card.dataset.didNotAttend === 'true';
        const newValue = !currentValue;

        try {
            await api.put(`/api/events/${eventId}/attendance`, { did_not_attend: newValue });

            // Update the UI
            card.dataset.didNotAttend = newValue ? 'true' : 'false';
            if (newValue) {
                card.classList.add('did-not-attend');
            } else {
                card.classList.remove('did-not-attend');
            }

            // Update the button
            const btn = card.querySelector('.btn-attendance');
            if (newValue) {
                btn.classList.add('active');
                btn.textContent = '✓';
                btn.title = 'Mark as attended';
            } else {
                btn.classList.remove('active');
                btn.textContent = '✗';
                btn.title = 'Mark as did not attend';
            }

            // Toggle the did-not-attend badge
            let badge = card.querySelector('.did-not-attend-badge');
            if (newValue && !badge) {
                badge = document.createElement('div');
                badge.className = 'did-not-attend-badge';
                badge.title = 'Did not attend';
                badge.textContent = '✗';
                card.insertBefore(badge, card.firstChild);
            } else if (!newValue && badge) {
                badge.remove();
            }

            // Disable/enable the project select
            const select = card.querySelector('.project-select');
            if (select) {
                select.disabled = newValue;
            }

            showToast(newValue ? 'Marked as did not attend' : 'Marked as attended', 'success');

        } catch (error) {
            showToast('Error updating attendance: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
