{% extends "base.html" %}

{% block title %}Week of {{ week_start.strftime('%b %d') }} - Timesheet{% endblock %}

{% block content %}
<div class="week-header">
    <div class="week-nav">
        <a href="/week/{{ prev_week }}" class="btn btn-secondary">&larr; Prev</a>
        <a href="/" class="btn btn-secondary">Today</a>
        <a href="/week/{{ next_week }}" class="btn btn-secondary">Next &rarr;</a>
    </div>
    <h1 class="week-title">Week of {{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}</h1>
    <div class="week-actions">
        <button id="sync-btn" class="btn btn-secondary" onclick="refreshEvents()">↻ Refresh</button>
        <a href="/api/export/harvest?start_date={{ week_start }}&end_date={{ week_end }}" class="btn btn-primary">Export CSV</a>
    </div>
</div>

<div class="filter-bar">
    <input type="text" id="filter-input" placeholder="Filter events..." onkeyup="filterEvents()">
</div>

<div class="week-container">
<div class="week-grid">
    {% for day in days %}
    <div class="day-column {% if day.is_today %}today{% endif %}">
        <div class="day-header">
            <span class="day-name">{{ day.day_name }}</span>
            <span class="day-number">{{ day.day_number }}</span>
        </div>
        <div class="day-events">
            {% for event in day.events %}
            <div class="event-card {% if event.is_classified %}classified{% else %}unclassified{% endif %}"
                 data-event-id="{{ event.id }}"
                 data-title="{{ event.title }}"
                 data-project="{{ event.project_name or '' }}">

                <!-- Event side (unclassified view) -->
                <div class="card-side card-event {% if event.is_classified %}hidden{% endif %}"
                     data-project-color="{{ event.project_color or '' }}">
                    {% if event.is_classified %}
                    <div class="project-badge" style="background-color: {{ event.project_color }}"></div>
                    {% endif %}
                    <div class="event-title">{{ event.title }}</div>
                    <div class="event-time">
                        {{ event.start_time[11:16] }} - {{ event.end_time[11:16] }}
                    </div>
                    {% if event.attendees %}
                    <div class="event-attendees">
                        {{ event.attendees | length }} attendee(s)
                    </div>
                    {% endif %}
                    {% if event.meeting_link %}
                    <a href="{{ event.meeting_link }}" target="_blank" class="event-link">Join</a>
                    {% endif %}
                    <div class="event-actions">
                        <select class="project-select" onchange="classifyEvent({{ event.id }}, this.value, this.options[this.selectedIndex].dataset.color)">
                            <option value="">Classify...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn-small btn-rule" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">⚙</button>
                        {% if event.is_classified %}
                        <button class="btn-small" onclick="flipCard({{ event.id }})">Flip</button>
                        {% endif %}
                    </div>
                </div>

                <!-- Time entry side (classified view) -->
                <div class="card-side card-entry {% if not event.is_classified %}hidden{% endif %}"
                     data-entry-id="{{ event.entry_id }}"
                     style="background-color: {{ event.project_color }}">
                    <div class="entry-header">
                        <select class="project-select entry-project-select" onchange="reclassifyEvent({{ event.id }}, {{ event.entry_id }}, this.value, this.options[this.selectedIndex].dataset.color)">
                            <option value="">— Unclassify —</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" data-color="{{ project.color or '#00aa44' }}" {% if project.id == event.project_id %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="entry-hours">
                        <span class="hours-value">{{ "%.2f"|format(event.hours or 0) }}</span> hrs
                        <button class="btn-small" onclick="roundUp({{ event.id }}, {{ event.entry_id }})">+15m</button>
                    </div>
                    <div class="entry-description">{{ event.entry_description or event.title }}</div>
                    <div class="entry-actions">
                        <button class="btn-small btn-rule" onclick="showCreateRuleModal({{ event.id }})" title="Create Rule">⚙</button>
                        <button class="btn-small" onclick="flipCard({{ event.id }})">Flip</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-events">No events</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<aside class="project-summary-sidebar">
    <h3>Project Summary</h3>
    <div class="summary-total">{{ "%.1f"|format(total_hours) }} hrs total</div>
    <div class="summary-list">
        {% for proj in project_summary %}
        <div class="summary-item" data-project-id="{{ proj.id }}">
            <label class="summary-toggle">
                <input type="checkbox" checked
                       onchange="toggleProjectVisibility({{ proj.id }}, this.checked)">
                <span class="summary-color" style="background-color: {{ proj.color }}"></span>
                <span class="summary-name">{{ proj.name }}</span>
            </label>
            <span class="summary-hours">{{ "%.1f"|format(proj.hours) }}</span>
            {% if total_hours > 0 %}
            <div class="summary-bar">
                <div class="summary-bar-fill" style="width: {{ (proj.hours / total_hours * 100)|int }}%; background-color: {{ proj.color }}"></div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</aside>
</div>
<!-- Create Rule Modal -->
<div id="rule-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Create Rule from Event</h2>
        <div id="rule-modal-loading">Loading event properties...</div>
        <div id="rule-modal-form" class="hidden">
            <div class="form-row">
                <label for="modal-rule-name">Rule Name:</label>
                <input type="text" id="modal-rule-name" placeholder="e.g., Client meetings">
            </div>

            <div class="form-row">
                <label for="modal-rule-project">Project:</label>
                <select id="modal-rule-project">
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label for="modal-rule-priority">Priority:</label>
                <input type="number" id="modal-rule-priority" value="50" min="0" max="100">
                <span class="form-hint">Higher = evaluated first</span>
            </div>

            <div class="event-properties-section">
                <h3>Event Properties</h3>
                <p class="form-hint">Select properties to use as conditions for this rule. The current values from this event will be pre-filled.</p>
                <div id="modal-properties-list"></div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveRuleFromModal()">Create Rule</button>
                <button class="btn btn-secondary" onclick="hideRuleModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
<script>
    // Initialize with current week dates
    window.weekStart = "{{ week_start }}";
    window.weekEnd = "{{ week_end }}";

    // Auto-sync on page load and restore visibility preferences
    document.addEventListener('DOMContentLoaded', function() {
        syncEventsQuiet();
        restoreProjectVisibility();
    });

    /**
     * Restore project visibility preferences from sessionStorage.
     */
    function restoreProjectVisibility() {
        const visibilityKey = `projectVisibility_${window.weekStart}`;
        const visibility = JSON.parse(sessionStorage.getItem(visibilityKey) || '{}');

        for (const [projectId, isVisible] of Object.entries(visibility)) {
            if (!isVisible) {
                // Update checkbox state
                const checkbox = document.querySelector(`.summary-item[data-project-id="${projectId}"] input[type="checkbox"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    // Trigger visibility update
                    toggleProjectVisibility(parseInt(projectId), false);
                }
            }
        }
    }

    // Rule creation from event
    let currentEventId = null;
    let propertyDefinitions = [];
    let conditionTypes = [];

    /**
     * Show the create rule modal for an event.
     */
    async function showCreateRuleModal(eventId) {
        currentEventId = eventId;
        const modal = document.getElementById('rule-modal');
        const loading = document.getElementById('rule-modal-loading');
        const form = document.getElementById('rule-modal-form');

        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        form.classList.add('hidden');

        try {
            // Fetch property definitions, condition types, and event properties in parallel
            const [propDefs, condTypes, eventProps] = await Promise.all([
                api.get('/api/properties'),
                api.get('/api/conditions'),
                api.get(`/api/events/${eventId}/properties`)
            ]);

            propertyDefinitions = propDefs;
            conditionTypes = condTypes;

            // Pre-fill rule name with event title
            const eventTitle = eventProps.title || 'Untitled';
            document.getElementById('modal-rule-name').value = `${eventTitle} Rule`;

            // Build the properties list with checkboxes
            const listContainer = document.getElementById('modal-properties-list');
            listContainer.innerHTML = '';

            for (const prop of propertyDefinitions) {
                const currentValue = eventProps[prop.name];
                // Skip properties with no value
                if (currentValue === null || currentValue === undefined || currentValue === '' ||
                    (Array.isArray(currentValue) && currentValue.length === 0)) {
                    continue;
                }

                const row = document.createElement('div');
                row.className = 'property-row';

                // Get applicable condition types for this property
                const applicableConditions = conditionTypes.filter(c =>
                    c.applies_to.includes(prop.value_type)
                );

                // Format the current value for display
                let displayValue = currentValue;
                if (Array.isArray(currentValue)) {
                    displayValue = currentValue.join(', ');
                }

                row.innerHTML = `
                    <label class="property-checkbox">
                        <input type="checkbox" class="prop-check" data-property="${prop.name}" data-type="${prop.value_type}">
                        <span class="prop-name">${prop.display_name}</span>
                    </label>
                    <select class="prop-condition" disabled>
                        ${applicableConditions.map(c => `<option value="${c.type}">${c.display}</option>`).join('')}
                    </select>
                    <input type="text" class="prop-value" value="${escapeHtml(String(displayValue))}" disabled>
                `;

                // Enable/disable condition and value when checkbox is toggled
                const checkbox = row.querySelector('.prop-check');
                const condSelect = row.querySelector('.prop-condition');
                const valueInput = row.querySelector('.prop-value');

                checkbox.addEventListener('change', () => {
                    condSelect.disabled = !checkbox.checked;
                    valueInput.disabled = !checkbox.checked;
                });

                listContainer.appendChild(row);
            }

            loading.classList.add('hidden');
            form.classList.remove('hidden');

        } catch (error) {
            alert('Error loading event properties: ' + error.message);
            hideRuleModal();
        }
    }

    /**
     * Hide the rule creation modal.
     */
    function hideRuleModal() {
        document.getElementById('rule-modal').classList.add('hidden');
        currentEventId = null;
    }

    /**
     * Save the rule from the modal form.
     */
    async function saveRuleFromModal() {
        const name = document.getElementById('modal-rule-name').value.trim();
        const projectId = parseInt(document.getElementById('modal-rule-project').value);
        const priority = parseInt(document.getElementById('modal-rule-priority').value);

        if (!name) {
            alert('Rule name is required');
            return;
        }

        // Gather selected conditions
        const conditions = [];
        const rows = document.querySelectorAll('.property-row');
        for (const row of rows) {
            const checkbox = row.querySelector('.prop-check');
            if (!checkbox.checked) continue;

            const propertyName = checkbox.dataset.property;
            const conditionType = row.querySelector('.prop-condition').value;
            let conditionValue = row.querySelector('.prop-value').value;

            // Convert comma-separated values to array for list types
            const propType = checkbox.dataset.type;
            if (propType === 'list' || conditionType === 'in_list') {
                conditionValue = conditionValue.split(',').map(v => v.trim()).filter(v => v);
            }

            conditions.push({
                property_name: propertyName,
                condition_type: conditionType,
                condition_value: conditionValue
            });
        }

        if (conditions.length === 0) {
            alert('At least one condition is required. Please select a property.');
            return;
        }

        try {
            await api.post('/api/rules', {
                name,
                project_id: projectId,
                priority,
                is_enabled: true,
                conditions
            });

            showToast('Rule created successfully!', 'success');
            hideRuleModal();

        } catch (error) {
            showToast('Error creating rule: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML for safe display.
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('rule-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideRuleModal();
        }
    });
</script>
{% endblock %}
