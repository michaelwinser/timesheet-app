{% extends "base.html" %}

{% block title %}Projects - Timesheet{% endblock %}

{% block content %}
<div class="projects-header">
    <h1>Projects</h1>
    <button class="btn btn-primary" onclick="showAddProject()">Add Project</button>
</div>

<div id="add-project-form" class="project-form hidden">
    <div class="form-row">
        <input type="text" id="new-project-name" placeholder="Project name">
        <input type="text" id="new-project-client" placeholder="Client (optional)">
        <div class="color-picker-group">
            <label for="new-project-color">Color:</label>
            <input type="color" id="new-project-color" value="#00aa44">
        </div>
    </div>
    <div class="form-row project-settings">
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-no-hours">
            No hours (Noise)
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-billable" onchange="toggleBillRate('new')">
            Billable
        </label>
        <div class="bill-rate-group hidden" id="new-bill-rate-group">
            <label>Rate: $</label>
            <input type="number" id="new-project-bill-rate" step="0.01" min="0" placeholder="0.00">
        </div>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-hidden">
            Hidden by default
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-archived">
            Archived
        </label>
    </div>
    <div class="form-row">
        <button class="btn btn-primary" onclick="addProject()">Save</button>
        <button class="btn btn-secondary" onclick="hideAddProject()">Cancel</button>
    </div>
</div>

<table class="projects-table">
    <thead>
        <tr>
            <th>Color</th>
            <th>Name</th>
            <th>Client</th>
            <th>Settings</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for project in projects %}
        <tr data-project-id="{{ project.id }}"
            data-name="{{ project.name }}"
            data-client="{{ project.client or '' }}"
            data-color="{{ project.color or '#00aa44' }}"
            data-no-hours="{{ 'true' if project.does_not_accumulate_hours else 'false' }}"
            data-billable="{{ 'true' if project.is_billable else 'false' }}"
            data-bill-rate="{{ project.bill_rate or '' }}"
            data-hidden="{{ 'true' if project.is_hidden_by_default else 'false' }}"
            data-archived="{{ 'true' if project.is_archived else 'false' }}"
            class="{% if project.is_archived %}archived-row{% endif %}">
            <td class="color-cell">
                <input type="color"
                       value="{{ project.color or '#00aa44' }}"
                       onchange="updateProjectColor({{ project.id }}, this.value)"
                       class="project-color-picker">
            </td>
            <td class="name-cell">
                <span class="display-value">{{ project.name }}</span>
                <input type="text" class="edit-input hidden" value="{{ project.name }}">
            </td>
            <td class="client-cell">
                <span class="display-value">{{ project.client or '-' }}</span>
                <input type="text" class="edit-input hidden" value="{{ project.client or '' }}" placeholder="(none)">
            </td>
            <td class="settings-cell">
                <span class="display-value">
                    {% if project.does_not_accumulate_hours %}<span class="badge badge-muted" title="Does not accumulate hours">No hrs</span>{% endif %}
                    {% if project.is_billable %}<span class="badge badge-success" title="Billable{% if project.bill_rate %} @ ${{ project.bill_rate }}/hr{% endif %}">${% if project.bill_rate %}{{ project.bill_rate }}{% endif %}</span>{% endif %}
                    {% if project.is_hidden_by_default %}<span class="badge badge-warning" title="Hidden by default">Hidden</span>{% endif %}
                    {% if project.is_archived %}<span class="badge badge-danger" title="Archived">Archived</span>{% endif %}
                    {% if not project.does_not_accumulate_hours and not project.is_billable and not project.is_hidden_by_default and not project.is_archived %}-{% endif %}
                </span>
                <div class="edit-settings hidden">
                    <label class="checkbox-label">
                        <input type="checkbox" class="no-hours-input" {% if project.does_not_accumulate_hours %}checked{% endif %}>
                        No hours
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="billable-input" {% if project.is_billable %}checked{% endif %} onchange="toggleBillRateRow({{ project.id }})">
                        Billable
                    </label>
                    <div class="bill-rate-inline {% if not project.is_billable %}hidden{% endif %}" id="bill-rate-{{ project.id }}">
                        $<input type="number" class="bill-rate-input" step="0.01" min="0" value="{{ project.bill_rate or '' }}" placeholder="0.00">
                    </div>
                    <label class="checkbox-label">
                        <input type="checkbox" class="hidden-input" {% if project.is_hidden_by_default %}checked{% endif %}>
                        Hidden
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="archived-input" {% if project.is_archived %}checked{% endif %}>
                        Archived
                    </label>
                </div>
            </td>
            <td class="actions-cell">
                <button class="btn-small edit-btn" onclick="editProject({{ project.id }})">Edit</button>
                <button class="btn-small btn-primary save-btn hidden" onclick="saveProject({{ project.id }})">Save</button>
                <button class="btn-small cancel-btn hidden" onclick="cancelEdit({{ project.id }})">Cancel</button>
                <button class="btn-small btn-danger delete-btn" onclick="deleteProject({{ project.id }})">Delete</button>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5" class="no-projects">No projects yet. Add one to get started.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="import-export">
    <h2>Import / Export</h2>
    <p class="hint">Export your projects to a JSON file for backup, or import projects from a previous export.</p>
    <div class="import-export-actions">
        <button class="btn btn-secondary" onclick="exportProjects()">Export JSON</button>
        <input type="file" id="import-file" accept=".json" style="display: none" onchange="handleImportFile(this)">
        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Import JSON</button>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Import Projects</h2>
        <div id="import-preview"></div>
        <div class="form-row">
            <label>Import Mode:</label>
            <select id="import-mode">
                <option value="merge">Merge (update existing, add new)</option>
                <option value="replace">Replace (delete all, then import)</option>
            </select>
        </div>
        <p class="hint" id="merge-hint">Merge mode will update projects with matching names and create new projects for others.</p>
        <p class="hint hidden" id="replace-hint" style="color: #dc3545;">Replace mode will DELETE all existing projects before importing!</p>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="doImport()">Import</button>
            <button class="btn btn-secondary" onclick="hideImportModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAddProject() {
    document.getElementById('add-project-form').classList.remove('hidden');
}

function hideAddProject() {
    document.getElementById('add-project-form').classList.add('hidden');
    document.getElementById('new-project-name').value = '';
    document.getElementById('new-project-client').value = '';
    document.getElementById('new-project-color').value = '#00aa44';
    document.getElementById('new-project-no-hours').checked = false;
    document.getElementById('new-project-billable').checked = false;
    document.getElementById('new-project-bill-rate').value = '';
    document.getElementById('new-bill-rate-group').classList.add('hidden');
    document.getElementById('new-project-hidden').checked = false;
    document.getElementById('new-project-archived').checked = false;
}

function toggleBillRate(prefix) {
    const checkbox = document.getElementById(`${prefix}-project-billable`);
    const group = document.getElementById(`${prefix}-bill-rate-group`);
    if (checkbox.checked) {
        group.classList.remove('hidden');
    } else {
        group.classList.add('hidden');
    }
}

function toggleBillRateRow(projectId) {
    const row = document.querySelector(`tr[data-project-id="${projectId}"]`);
    const checkbox = row.querySelector('.billable-input');
    const group = document.getElementById(`bill-rate-${projectId}`);
    if (checkbox.checked) {
        group.classList.remove('hidden');
    } else {
        group.classList.add('hidden');
    }
}

async function addProject() {
    const name = document.getElementById('new-project-name').value.trim();
    const client = document.getElementById('new-project-client').value.trim();
    const color = document.getElementById('new-project-color').value;
    const noHours = document.getElementById('new-project-no-hours').checked;
    const billable = document.getElementById('new-project-billable').checked;
    const billRate = document.getElementById('new-project-bill-rate').value;
    const hidden = document.getElementById('new-project-hidden').checked;
    const archived = document.getElementById('new-project-archived').checked;

    if (!name) {
        alert('Project name is required');
        return;
    }

    await api.post('/api/projects', {
        name,
        client: client || null,
        color,
        does_not_accumulate_hours: noHours,
        is_billable: billable,
        bill_rate: billRate ? parseFloat(billRate) : null,
        is_hidden_by_default: hidden,
        is_archived: archived
    });
    location.reload();
}

async function updateProjectColor(projectId, color) {
    await api.put(`/api/projects/${projectId}`, { color });
}

async function toggleVisibility(projectId, isVisible) {
    await api.put(`/api/projects/${projectId}/visibility`, { is_visible: isVisible });
}

async function deleteProject(projectId) {
    if (!confirm('Delete this project? Time entries will be orphaned.')) return;
    await api.delete(`/api/projects/${projectId}`);
    location.reload();
}

function editProject(projectId) {
    const row = document.querySelector(`tr[data-project-id="${projectId}"]`);

    // Show edit inputs, hide display values
    row.querySelectorAll('.display-value').forEach(el => el.classList.add('hidden'));
    row.querySelectorAll('.edit-input').forEach(el => el.classList.remove('hidden'));
    row.querySelector('.edit-settings').classList.remove('hidden');

    // Toggle buttons
    row.querySelector('.edit-btn').classList.add('hidden');
    row.querySelector('.delete-btn').classList.add('hidden');
    row.querySelector('.save-btn').classList.remove('hidden');
    row.querySelector('.cancel-btn').classList.remove('hidden');

    // Focus the name input
    row.querySelector('.name-cell .edit-input').focus();
}

function cancelEdit(projectId) {
    const row = document.querySelector(`tr[data-project-id="${projectId}"]`);

    // Restore original values
    row.querySelector('.name-cell .edit-input').value = row.dataset.name;
    row.querySelector('.client-cell .edit-input').value = row.dataset.client;
    row.querySelector('.no-hours-input').checked = row.dataset.noHours === 'true';
    row.querySelector('.billable-input').checked = row.dataset.billable === 'true';
    row.querySelector('.bill-rate-input').value = row.dataset.billRate;
    row.querySelector('.hidden-input').checked = row.dataset.hidden === 'true';
    row.querySelector('.archived-input').checked = row.dataset.archived === 'true';

    // Hide edit inputs, show display values
    row.querySelectorAll('.display-value').forEach(el => el.classList.remove('hidden'));
    row.querySelectorAll('.edit-input').forEach(el => el.classList.add('hidden'));
    row.querySelector('.edit-settings').classList.add('hidden');

    // Toggle buttons
    row.querySelector('.edit-btn').classList.remove('hidden');
    row.querySelector('.delete-btn').classList.remove('hidden');
    row.querySelector('.save-btn').classList.add('hidden');
    row.querySelector('.cancel-btn').classList.add('hidden');
}

async function saveProject(projectId) {
    const row = document.querySelector(`tr[data-project-id="${projectId}"]`);
    const name = row.querySelector('.name-cell .edit-input').value.trim();
    const client = row.querySelector('.client-cell .edit-input').value.trim();
    const noHours = row.querySelector('.no-hours-input').checked;
    const billable = row.querySelector('.billable-input').checked;
    const billRate = row.querySelector('.bill-rate-input').value;
    const hidden = row.querySelector('.hidden-input').checked;
    const archived = row.querySelector('.archived-input').checked;

    if (!name) {
        alert('Project name is required');
        return;
    }

    try {
        await api.put(`/api/projects/${projectId}`, {
            name,
            client: client || null,
            does_not_accumulate_hours: noHours,
            is_billable: billable,
            bill_rate: billRate ? parseFloat(billRate) : null,
            is_hidden_by_default: hidden,
            is_archived: archived
        });

        // Reload to show updated badges
        location.reload();
    } catch (error) {
        alert('Save failed: ' + error.message);
    }
}

// --- Import / Export ---

let pendingImportData = null;

async function exportProjects() {
    try {
        const data = await api.get('/api/projects/export');

        // Create and download JSON file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `projects-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast(`Exported ${data.projects.length} projects`, 'success');
    } catch (error) {
        showToast('Export failed: ' + error.message, 'error');
    }
}

function handleImportFile(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            if (!data.projects || !Array.isArray(data.projects)) {
                throw new Error('Invalid format: missing projects array');
            }

            pendingImportData = data;
            showImportModal(data);
        } catch (error) {
            showToast('Invalid JSON file: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);

    // Reset input so same file can be selected again
    input.value = '';
}

function showImportModal(data) {
    const preview = document.getElementById('import-preview');
    const projectNames = data.projects.map(p => p.name).slice(0, 10);
    const moreCount = data.projects.length - 10;

    preview.innerHTML = `
        <p><strong>${data.projects.length}</strong> project(s) found:</p>
        <ul class="import-preview-list">
            ${projectNames.map(n => `<li>${escapeHtml(n)}</li>`).join('')}
            ${moreCount > 0 ? `<li>...and ${moreCount} more</li>` : ''}
        </ul>
    `;

    document.getElementById('import-modal').classList.remove('hidden');
    document.getElementById('import-mode').value = 'merge';
    updateModeHints();

    // Add listener for mode changes
    document.getElementById('import-mode').onchange = updateModeHints;
}

function updateModeHints() {
    const mode = document.getElementById('import-mode').value;
    document.getElementById('merge-hint').classList.toggle('hidden', mode !== 'merge');
    document.getElementById('replace-hint').classList.toggle('hidden', mode !== 'replace');
}

function hideImportModal() {
    document.getElementById('import-modal').classList.add('hidden');
    pendingImportData = null;
}

async function doImport() {
    if (!pendingImportData) return;

    const mode = document.getElementById('import-mode').value;

    if (mode === 'replace') {
        if (!confirm('This will DELETE all existing projects before importing. Are you sure?')) {
            return;
        }
    }

    try {
        const result = await api.post('/api/projects/import', {
            ...pendingImportData,
            mode: mode
        });

        const messages = [];
        if (result.imported > 0) messages.push(`${result.imported} imported`);
        if (result.updated > 0) messages.push(`${result.updated} updated`);
        if (result.skipped > 0) messages.push(`${result.skipped} skipped`);

        showToast(messages.join(', ') || 'No changes made', 'success');
        hideImportModal();
        location.reload();
    } catch (error) {
        showToast('Import failed: ' + error.message, 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal when clicking outside
document.getElementById('import-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        hideImportModal();
    }
});
</script>
{% endblock %}
