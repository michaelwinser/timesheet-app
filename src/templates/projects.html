{% extends "base.html" %}

{% block title %}Projects - Timesheet{% endblock %}

{% block content %}
<div class="projects-header">
    <h1>Projects</h1>
    <button class="btn btn-primary" onclick="showAddProject()">Add Project</button>
</div>

<div id="add-project-form" class="project-form hidden">
    <div class="form-row">
        <input type="text" id="new-project-name" placeholder="Project name">
        <input type="text" id="new-project-client" placeholder="Client (optional)">
        <input type="text" id="new-project-short-code" placeholder="Short code (e.g. ABC)" maxlength="10" style="width: 120px;">
        <div class="color-picker-group">
            <label for="new-project-color">Color:</label>
            <input type="color" id="new-project-color" value="#00aa44">
        </div>
    </div>
    <div class="form-row project-settings">
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-no-hours">
            No hours (Noise)
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-billable" onchange="toggleBillRate('new')">
            Billable
        </label>
        <div class="bill-rate-group hidden" id="new-bill-rate-group">
            <label>Rate: $</label>
            <input type="number" id="new-project-bill-rate" step="0.01" min="0" placeholder="0.00">
        </div>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-hidden">
            Hidden by default
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="new-project-archived">
            Archived
        </label>
    </div>
    <div class="form-row">
        <button class="btn btn-primary" onclick="addProject()">Save</button>
        <button class="btn btn-secondary" onclick="hideAddProject()">Cancel</button>
    </div>
</div>

{% if project_groups %}
{% for client_name, projects in project_groups %}
<div class="project-group" data-client="{{ client_name }}">
    <div class="client-header">{{ client_name }}</div>
    <div class="project-list">
        {% for project in projects %}
        <div class="project-row{% if project.is_archived %} archived{% endif %}" data-project-id="{{ project.id }}">
            <a href="/projects/{{ project.id }}" class="project-name">{{ project.name }}</a>
            {% if project.short_code %}<span class="project-chip" style="background-color: {{ project.color or '#00aa44' }}">{{ project.short_code }}</span>{% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% else %}
<p class="no-projects">No projects yet. Add one to get started.</p>
{% endif %}

<div class="import-export">
    <h2>Import / Export</h2>
    <p class="hint">Export your projects to a JSON file for backup, or import projects from a previous export.</p>
    <div class="import-export-actions">
        <button class="btn btn-secondary" onclick="exportProjects()">Export JSON</button>
        <input type="file" id="import-file" accept=".json" style="display: none" onchange="handleImportFile(this)">
        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Import JSON</button>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Import Projects</h2>
        <div id="import-preview"></div>
        <div class="form-row">
            <label>Import Mode:</label>
            <select id="import-mode">
                <option value="merge">Merge (update existing, add new)</option>
                <option value="replace">Replace (delete all, then import)</option>
            </select>
        </div>
        <p class="hint" id="merge-hint">Merge mode will update projects with matching names and create new projects for others.</p>
        <p class="hint hidden" id="replace-hint" style="color: #dc3545;">Replace mode will DELETE all existing projects before importing!</p>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="doImport()">Import</button>
            <button class="btn btn-secondary" onclick="hideImportModal()">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
.project-group {
    margin-bottom: 1.5rem;
}
.client-header {
    font-size: 1rem;
    font-weight: 600;
    color: #888;
    margin: 0 0 0.5rem 0;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #333;
}
.project-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.project-row {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    padding: 0.4rem 0.75rem;
}
.project-row:hover {
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
}
.project-row.archived {
    opacity: 0.5;
}
.project-name {
    color: #e0e0e0;
    text-decoration: none;
}
.project-name:hover {
    color: #fff;
}
</style>
<script>
// Apply text color to project chips based on background
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.project-chip').forEach(function(chip) {
        applyTextColorClass(chip, chip.style.backgroundColor);
    });
});

function showAddProject() {
    document.getElementById('add-project-form').classList.remove('hidden');
}

function hideAddProject() {
    document.getElementById('add-project-form').classList.add('hidden');
    document.getElementById('new-project-name').value = '';
    document.getElementById('new-project-client').value = '';
    document.getElementById('new-project-short-code').value = '';
    document.getElementById('new-project-color').value = '#00aa44';
    document.getElementById('new-project-no-hours').checked = false;
    document.getElementById('new-project-billable').checked = false;
    document.getElementById('new-project-bill-rate').value = '';
    document.getElementById('new-bill-rate-group').classList.add('hidden');
    document.getElementById('new-project-hidden').checked = false;
    document.getElementById('new-project-archived').checked = false;
}

function toggleBillRate(prefix) {
    const checkbox = document.getElementById(`${prefix}-project-billable`);
    const group = document.getElementById(`${prefix}-bill-rate-group`);
    if (checkbox.checked) {
        group.classList.remove('hidden');
    } else {
        group.classList.add('hidden');
    }
}

async function addProject() {
    const name = document.getElementById('new-project-name').value.trim();
    const client = document.getElementById('new-project-client').value.trim();
    const shortCode = document.getElementById('new-project-short-code').value.trim();
    const color = document.getElementById('new-project-color').value;
    const noHours = document.getElementById('new-project-no-hours').checked;
    const billable = document.getElementById('new-project-billable').checked;
    const billRate = document.getElementById('new-project-bill-rate').value;
    const hidden = document.getElementById('new-project-hidden').checked;
    const archived = document.getElementById('new-project-archived').checked;

    if (!name) {
        alert('Project name is required');
        return;
    }

    await api.post('/api/projects', {
        name,
        client: client || null,
        short_code: shortCode || null,
        color,
        does_not_accumulate_hours: noHours,
        is_billable: billable,
        bill_rate: billRate ? parseFloat(billRate) : null,
        is_hidden_by_default: hidden,
        is_archived: archived
    });
    location.reload();
}

// --- Import / Export ---

let pendingImportData = null;

async function exportProjects() {
    try {
        const data = await api.get('/api/projects/export');

        // Create and download JSON file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `projects-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast(`Exported ${data.projects.length} projects`, 'success');
    } catch (error) {
        showToast('Export failed: ' + error.message, 'error');
    }
}

function handleImportFile(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            if (!data.projects || !Array.isArray(data.projects)) {
                throw new Error('Invalid format: missing projects array');
            }

            pendingImportData = data;
            showImportModal(data);
        } catch (error) {
            showToast('Invalid JSON file: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);

    // Reset input so same file can be selected again
    input.value = '';
}

function showImportModal(data) {
    const preview = document.getElementById('import-preview');
    const projectNames = data.projects.map(p => p.name).slice(0, 10);
    const moreCount = data.projects.length - 10;

    preview.innerHTML = `
        <p><strong>${data.projects.length}</strong> project(s) found:</p>
        <ul class="import-preview-list">
            ${projectNames.map(n => `<li>${escapeHtml(n)}</li>`).join('')}
            ${moreCount > 0 ? `<li>...and ${moreCount} more</li>` : ''}
        </ul>
    `;

    document.getElementById('import-modal').classList.remove('hidden');
    document.getElementById('import-mode').value = 'merge';
    updateModeHints();

    // Add listener for mode changes
    document.getElementById('import-mode').onchange = updateModeHints;
}

function updateModeHints() {
    const mode = document.getElementById('import-mode').value;
    document.getElementById('merge-hint').classList.toggle('hidden', mode !== 'merge');
    document.getElementById('replace-hint').classList.toggle('hidden', mode !== 'replace');
}

function hideImportModal() {
    document.getElementById('import-modal').classList.add('hidden');
    pendingImportData = null;
}

async function doImport() {
    if (!pendingImportData) return;

    const mode = document.getElementById('import-mode').value;

    if (mode === 'replace') {
        if (!confirm('This will DELETE all existing projects before importing. Are you sure?')) {
            return;
        }
    }

    try {
        const result = await api.post('/api/projects/import', {
            ...pendingImportData,
            mode: mode
        });

        const messages = [];
        if (result.imported > 0) messages.push(`${result.imported} imported`);
        if (result.updated > 0) messages.push(`${result.updated} updated`);
        if (result.skipped > 0) messages.push(`${result.skipped} skipped`);

        showToast(messages.join(', ') || 'No changes made', 'success');
        hideImportModal();
        location.reload();
    } catch (error) {
        showToast('Import failed: ' + error.message, 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal when clicking outside
document.getElementById('import-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        hideImportModal();
    }
});
</script>
{% endblock %}
